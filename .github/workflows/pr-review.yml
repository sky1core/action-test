name: PR Review

on:
  # PR ìƒì„± ì‹œ ë¼ë²¨ ì¶”ê°€, ë¼ë²¨ ì œê±°/í‘¸ì‹œ ì‹œ ë¦¬ë·° ì‹¤í–‰
  pull_request:
    types: [opened, unlabeled, synchronize]
    # âš ï¸ ë™ê¸°í™” í•„ìš”: ëŒ€ìƒ ë¸Œëœì¹˜ëŠ” approval-override.ymlì˜ job if ì¡°ê±´ê³¼ í•¨ê»˜ ë³€ê²½í•  ê²ƒ.
    branches: [main, master]

  # ìˆ˜ë™ ì‹¤í–‰
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR ë²ˆí˜¸'
        required: true
        type: number
      run_type:
        description: 'ì‹¤í–‰ ìœ í˜•'
        required: true
        type: choice
        options:
          - ai-review
          - unit-test

# ë™ì¼ PRì— ëŒ€í•´ ìˆœì°¨ ì‹¤í–‰ (ë™ì‹œ ì‹¤í–‰ ë°©ì§€)
concurrency:
  group: pr-review-${{ github.event.pull_request.number || github.event.inputs.pr_number || github.ref }}
  cancel-in-progress: false

env:
  REQUIRED_COUNT: 2
  COOLDOWN_MINUTES: 20
  NOT_READY_LABEL: "ğŸš§ WIP"
  REVIEW_PREFIX: "AI Review"
  TEST_PREFIX: "Unit Test"
  # AI ëª¨ë¸ ì„ íƒ (Bedrock ëª¨ë¸ ID)
  # - us.amazon.nova-micro-v1:0 (ê°€ì¥ ì €ë ´, $0.035/1M)
  # - anthropic.claude-4-sonnet-20250514-v1:0 ($3/1M)
  # - anthropic.claude-opus-4-5-20251101-v1:0 ($5/1M)
  # - deepseek.deepseek-r1-v1:0 ($1.35/1M, ì¶”ë¡  íŠ¹í™”)
  # - moonshot.kimi-k2-thinking-v1:0 ($0.60/1M, ì˜¤í”ˆ ìµœê³ )
  AI_MODEL: "us.amazon.nova-micro-v1:0"

jobs:
  # PR ìƒì„± ì‹œ ë¼ë²¨ ì¶”ê°€
  add-label:
    if: github.event.action == 'opened'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      statuses: write
      issues: write
    steps:
      - name: Create and add label
        run: |
          gh label create "${{ env.NOT_READY_LABEL }}" --description "ë¦¬ë·° ì¤€ë¹„ ì•ˆë¨" --color fbca04 || true
          gh pr edit ${{ github.event.pull_request.number }} --add-label "${{ env.NOT_READY_LABEL }}"

          gh api /repos/${{ github.repository }}/statuses/${{ github.event.pull_request.head.sha }} \
            -f state=pending \
            -f context="PR Review Status" \
            -f description="Remove WIP label to start review"

          cat > comment.md << EOF
          ### AI ì½”ë“œ ë¦¬ë·°

          ë¦¬ë·° ë°›ì„ ì¤€ë¹„ê°€ ë˜ë©´ \`${{ env.NOT_READY_LABEL }}\` ë¼ë²¨ì„ ì œê±°í•˜ì„¸ìš”.

          - ë¼ë²¨ ì œê±° â†’ ë‹¨ìœ„í…ŒìŠ¤íŠ¸ ì‹¤í–‰ â†’ í†µê³¼í•˜ë©´ AI ë¦¬ë·° 1íšŒ ìë™ ì‹¤í–‰
          - ì¶”ê°€ ë¦¬ë·°ëŠ” [Actionsì—ì„œ ìˆ˜ë™ ì‹¤í–‰](${{ github.server_url }}/${{ github.repository }}/actions/workflows/pr-review.yml)
          - ë¨¸ì§€ ì¡°ê±´: ìœ ë‹›í…ŒìŠ¤íŠ¸ + AI ë¦¬ë·° ${{ env.REQUIRED_COUNT }}ê°œ í†µê³¼, ë˜ëŠ” [Approve](${{ github.server_url }}/${{ github.repository }}/pull/${{ github.event.pull_request.number }}/files) (Files changed â†’ Review changes â†’ Approve)
          - í‘¸ì‹œí•˜ë©´ ì´ì „ ê¸°ë¡ ì´ˆê¸°í™” (ë‹¤ì‹œ ${{ env.REQUIRED_COUNT }}ê°œ í†µê³¼ í•„ìš”)
          - ìë™ ë¦¬ë·°ëŠ” ${{ env.COOLDOWN_MINUTES }}ë¶„ ê°„ê²© ì œí•œ (ìˆ˜ë™ ì‹¤í–‰ì€ ì œí•œ ì—†ìŒ)
          EOF
          gh pr comment ${{ github.event.pull_request.number }} --body-file comment.md
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}

  # ë¼ë²¨ ì²´í¬ (ë‹¨ìœ„í…ŒìŠ¤íŠ¸ ì „ì— ë¨¼ì € í™•ì¸)
  check-label:
    if: github.event.action != 'opened'
    runs-on: ubuntu-latest
    outputs:
      should_continue: ${{ steps.check.outputs.should_continue }}
      pr_number: ${{ steps.check.outputs.pr_number }}
    steps:
      - uses: actions/checkout@v4

      - name: Check label
        id: check
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            PR_NUMBER="${{ github.event.inputs.pr_number }}"
          else
            PR_NUMBER="${{ github.event.pull_request.number }}"
          fi

          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT

          if [ -z "$PR_NUMBER" ]; then
            echo "PR ì—†ìŒ - ìŠ¤í‚µ"
            echo "should_continue=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # unlabeled ì´ë²¤íŠ¸: WIP ë¼ë²¨ ì œê±°ê°€ ì•„ë‹ˆë©´ ìŠ¤í‚µ
          if [ "${{ github.event.action }}" = "unlabeled" ]; then
            REMOVED_LABEL="${{ github.event.label.name }}"
            if [ "$REMOVED_LABEL" != "${{ env.NOT_READY_LABEL }}" ]; then
              echo "ë‹¤ë¥¸ ë¼ë²¨($REMOVED_LABEL) ì œê±° - ìŠ¤í‚µ"
              echo "should_continue=false" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi

          # ë¼ë²¨ í™•ì¸ (ìˆ˜ë™ ì‹¤í–‰ì€ ë¼ë²¨ ë¬´ì‹œ)
          if [ "${{ github.event_name }}" != "workflow_dispatch" ]; then
            HAS_LABEL=$(gh pr view $PR_NUMBER --json labels --jq '[.labels[].name] | map(select(. == "${{ env.NOT_READY_LABEL }}")) | length')
            if [ "$HAS_LABEL" != "0" ]; then
              echo "ğŸš§ ë¼ë²¨ ìˆìŒ - ìŠ¤í‚µ"
              echo "should_continue=false" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi

          echo "should_continue=true" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ì¿¨ë‹¤ìš´ ì²´í¬ (marker statusë§Œ í™•ì¸í•˜ëŠ” ë¬¸ì§€ê¸°)
  cooldown-check:
    if: github.event.action != 'opened' && needs.check-label.outputs.should_continue == 'true'
    needs: check-label
    runs-on: ubuntu-latest
    outputs:
      should_skip: ${{ steps.check.outputs.should_skip }}
    steps:
      - name: Check cooldown marker
        id: check
        run: |
          # ìˆ˜ë™ ì‹¤í–‰ì€ ì¿¨ë‹¤ìš´ ë¬´ì‹œ
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "should_skip=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # ì´ ë¸Œëœì¹˜ì˜ ì´ì „ ì›Œí¬í”Œë¡œìš° runë“¤ í™•ì¸
          RUNS=$(gh run list --workflow=pr-review.yml --branch=${{ github.head_ref }} --json databaseId,headSha,createdAt --limit=10)

          CURRENT_RUN_ID="${{ github.run_id }}"

          for row in $(echo "$RUNS" | jq -c '.[]'); do
            RUN_ID=$(echo "$row" | jq -r '.databaseId')
            RUN_SHA=$(echo "$row" | jq -r '.headSha')

            # í˜„ì¬ run ìŠ¤í‚µ
            if [ "$RUN_ID" = "$CURRENT_RUN_ID" ]; then
              continue
            fi

            # í•´ë‹¹ ì»¤ë°‹ì— cooldown-markerê°€ ìˆëŠ”ì§€ í™•ì¸
            MARKER=$(gh api /repos/${{ github.repository }}/commits/$RUN_SHA/statuses \
              --jq '[.[] | select(.context == "cooldown-marker")] | .[0]')

            if [ -n "$MARKER" ] && [ "$MARKER" != "null" ]; then
              # marker ìˆìŒ - ì‹œê°„ í™•ì¸
              MARKER_TIME=$(echo "$MARKER" | jq -r '.updated_at')
              MARKER_SEC=$(date -d "$MARKER_TIME" +%s)
              NOW_SEC=$(date +%s)
              DIFF=$((NOW_SEC - MARKER_SEC))
              COOLDOWN_SEC=$((${{ env.COOLDOWN_MINUTES }} * 60))

              if [ $DIFF -lt $COOLDOWN_SEC ]; then
                REMAINING=$(((COOLDOWN_SEC - DIFF) / 60 + 1))
                echo "âŒ ì¿¨ë‹¤ìš´ ì¤‘ - ${REMAINING}ë¶„ í›„ ê°€ëŠ¥"

                # ì¿¨ë‹¤ìš´ ì‹œì—ë„ PR Review Statusë¥¼ pendingìœ¼ë¡œ ì„¤ì • (ìƒˆ ì»¤ë°‹ì— status í•„ìš”)
                PR_NUMBER="${{ needs.check-label.outputs.pr_number }}"
                HEAD_SHA=$(gh pr view $PR_NUMBER --json headRefOid --jq '.headRefOid')
                gh api /repos/${{ github.repository }}/statuses/$HEAD_SHA \
                  -f state=pending \
                  -f context="PR Review Status" \
                  -f description="â³ ${REMAINING}min"

                echo "should_skip=true" >> $GITHUB_OUTPUT
                exit 0
              fi
            fi
          done

          echo "should_skip=false" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}

  # ë‹¨ìœ„í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (ìë™ ë˜ëŠ” ìˆ˜ë™ unit-test ì„ íƒ ì‹œ)
  unit-test:
    if: |
      github.event.action != 'opened' &&
      needs.check-label.outputs.should_continue == 'true' &&
      needs.cooldown-check.outputs.should_skip != 'true' &&
      (github.event_name != 'workflow_dispatch' || github.event.inputs.run_type == 'unit-test')
    needs: [check-label, cooldown-check]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Run unit tests
        id: unit-test
        run: |
          uv run pytest tests/ -v 2>&1 | tee test_output.txt
          echo "exit_code=${PIPESTATUS[0]}" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Set unit test status
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          HEAD_SHA=$(gh pr view ${{ needs.check-label.outputs.pr_number }} --json headRefOid --jq '.headRefOid')

          if [ "${{ steps.unit-test.outputs.exit_code }}" = "0" ]; then
            STATE="success"
            DESC="Unit test passed"
          else
            STATE="failure"
            DESC="Unit test failed"

            # unit-test ì‹¤íŒ¨ ì‹œ PR Review Statusë„ failureë¡œ ì„¤ì •
            gh api /repos/${{ github.repository }}/statuses/$HEAD_SHA \
              -f state=failure \
              -f context="PR Review Status" \
              -f description="Unit test failed - Approval required"
          fi

          gh api /repos/${{ github.repository }}/statuses/$HEAD_SHA \
            -f state="$STATE" \
            -f context="unit-test" \
            -f description="$DESC"

      - name: Set cooldown marker
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          HEAD_SHA=$(gh pr view ${{ needs.check-label.outputs.pr_number }} --json headRefOid --jq '.headRefOid')
          gh api /repos/${{ github.repository }}/statuses/$HEAD_SHA \
            -f state=success \
            -f context="cooldown-marker" \
            -f description="Work completed at $(date -Iseconds)"

      - name: Comment on unit test failure
        if: steps.unit-test.outputs.exit_code != '0'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER="${{ needs.check-label.outputs.pr_number }}"
          HEAD_SHA=$(gh pr view $PR_NUMBER --json headRefOid --jq '.headRefOid')
          SHORT_SHA="${HEAD_SHA:0:7}"

          {
            printf '## âŒ ${{ env.TEST_PREFIX }} - FAIL\n\nAI review skipped due to test failure.\n\n```\n'
            tail -50 test_output.txt
            printf '\n```\n\nğŸ“Œ %s' "$SHORT_SHA"
          } > comment.md

          gh pr comment "$PR_NUMBER" --body-file comment.md

      - name: Collapse old unit test failure comments
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER="${{ needs.check-label.outputs.pr_number }}"
          HEAD_SHA=$(gh pr view $PR_NUMBER --json headRefOid --jq '.headRefOid')
          SHORT_SHA="${HEAD_SHA:0:7}"

          # í˜„ì¬ ì»¤ë°‹ SHAê°€ ì•„ë‹Œ ì´ì „ ë‹¨ìœ„í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ ëŒ“ê¸€ë§Œ ì ‘ê¸°
          COMMENTS=$(gh api "/repos/${{ github.repository }}/issues/${PR_NUMBER}/comments" \
            --jq '[.[] | select(.body | startswith("## âŒ ${{ env.TEST_PREFIX }}")) | select(.body | contains("<details>") | not) | {id, body}]')

          echo "$COMMENTS" | jq -c '.[]' | while read -r comment; do
            COMMENT_ID=$(echo "$comment" | jq -r '.id')
            BODY=$(echo "$comment" | jq -r '.body')

            # í˜„ì¬ ì»¤ë°‹ì˜ ëŒ“ê¸€ì´ë©´ ìŠ¤í‚µ
            if echo "$BODY" | grep -q "ğŸ“Œ ${SHORT_SHA}"; then
              echo "í˜„ì¬ ì»¤ë°‹ ëŒ“ê¸€ ìŠ¤í‚µ: $COMMENT_ID"
              continue
            fi

            echo "ì ‘ê¸° ì²˜ë¦¬: ì½”ë©˜íŠ¸ $COMMENT_ID"
            FIRST_LINE=$(echo "$BODY" | head -1)
            REST=$(echo "$BODY" | tail -n +2)

            printf '%s\n\n<details>\n<summary>í¼ì³ì„œ ë³´ê¸°</summary>\n%s\n</details>' "$FIRST_LINE" "$REST" > new_body.md

            gh api "/repos/${{ github.repository }}/issues/comments/${COMMENT_ID}" \
              -X PATCH \
              -F body=@new_body.md
          done

      - name: Fail if unit tests failed
        if: steps.unit-test.outputs.exit_code != '0'
        run: exit 1

  # AI ì½”ë“œ ë¦¬ë·° ì‹¤í–‰
  ai-review:
    if: |
      always() &&
      github.event.action != 'opened' &&
      needs.check-label.outputs.should_continue == 'true' &&
      needs.cooldown-check.outputs.should_skip != 'true' &&
      (
        (github.event_name == 'workflow_dispatch' && github.event.inputs.run_type == 'ai-review') ||
        (github.event_name != 'workflow_dispatch' && needs.unit-test.result == 'success')
      )
    needs: [check-label, cooldown-check, unit-test]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      statuses: write

    outputs:
      result: ${{ steps.ai-check.outputs.result }}
      slot: ${{ steps.check.outputs.next_slot }}
      head_sha: ${{ steps.check.outputs.head_sha }}
      pr_number: ${{ steps.check.outputs.pr_number }}

    steps:
      - name: Check slot availability
        id: check
        run: |
          PR_NUMBER="${{ needs.check-label.outputs.pr_number }}"
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT

          # PR HEAD SHA ì¡°íšŒ
          HEAD_SHA=$(gh pr view $PR_NUMBER --json headRefOid --jq '.headRefOid')
          echo "head_sha=$HEAD_SHA" >> $GITHUB_OUTPUT

          # ê¸°ì¡´ status í™•ì¸
          STATUSES=$(gh api /repos/${{ github.repository }}/commits/$HEAD_SHA/statuses --jq '[.[] | select(.context | startswith("ai-review-"))]')

          # ë¹ˆ ìŠ¬ë¡¯ ì°¾ê¸°
          NEXT_SLOT=0
          for i in $(seq 1 ${{ env.REQUIRED_COUNT }}); do
            EXISTS=$(echo "$STATUSES" | jq --arg ctx "ai-review-$i" '[.[] | select(.context == $ctx)] | length')
            if [ "$EXISTS" = "0" ]; then
              NEXT_SLOT=$i
              break
            fi
          done

          echo "next_slot=$NEXT_SLOT" >> $GITHUB_OUTPUT

          # ëª¨ë“  ìŠ¬ë¡¯ ì±„ì›Œì§
          if [ "$NEXT_SLOT" = "0" ]; then
            echo "âŒ ì´ë¯¸ ${{ env.REQUIRED_COUNT }}ê°œ ë¦¬ë·° ì™„ë£Œ"
            echo "should_run=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "âœ… ë¦¬ë·° ì‹¤í–‰ (ìŠ¬ë¡¯: ai-review-$NEXT_SLOT)"
          echo "should_run=true" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}

      - name: Get PR diff
        if: steps.check.outputs.should_run == 'true'
        id: diff
        run: |
          gh pr diff ${{ steps.check.outputs.pr_number }} > diff.txt
          DIFF_SIZE=$(wc -c < diff.txt)
          echo "diff_size=$DIFF_SIZE" >> $GITHUB_OUTPUT
          echo "ğŸ“Š Diff í¬ê¸°: $DIFF_SIZE bytes"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}

      - name: Set pending status
        if: steps.check.outputs.should_run == 'true'
        run: |
          gh api /repos/${{ github.repository }}/statuses/${{ steps.check.outputs.head_sha }} \
            -f state=pending \
            -f context="ai-review-${{ steps.check.outputs.next_slot }}" \
            -f description="AI review in progress..."
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Run AI Review
        if: steps.check.outputs.should_run == 'true'
        id: ai-check
        run: |
          echo "ğŸ¤– AI ì½”ë“œ ë¦¬ë·° ì‹¤í–‰ ì¤‘..."

          DIFF_CONTENT=$(cat diff.txt)

          # í”„ë¡œì íŠ¸ë³„ ë¦¬ë·° ê·œì¹™ íŒŒì¼ í™•ì¸
          CUSTOM_RULES=""
          if [ -f ".github/pr-review-rules.md" ]; then
            CUSTOM_RULES=$(cat .github/pr-review-rules.md)
            echo "ğŸ“‹ í”„ë¡œì íŠ¸ë³„ ë¦¬ë·° ê·œì¹™ ë¡œë“œë¨"
          fi

          # Bedrock API í˜¸ì¶œ (Tool Useë¡œ êµ¬ì¡°í™”ëœ ì‘ë‹µ ê°•ì œ)
          RESPONSE=$(curl -s -X POST "https://bedrock-runtime.us-east-1.amazonaws.com/model/${{ env.AI_MODEL }}/converse" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.BEDROCK_API_KEY }}" \
            -d "$(jq -n --arg diff "$DIFF_CONTENT" --arg rules "$CUSTOM_RULES" '{
              "messages": [
                {
                  "role": "user",
                  "content": [{"text": ("ë‹¹ì‹ ì€ ì‹œë‹ˆì–´ ê°œë°œìì…ë‹ˆë‹¤. ì½”ë“œ ë³€ê²½ì‚¬í•­ì„ ë¦¬ë·°í•˜ê³  submit_review ë„êµ¬ë¡œ ê²°ê³¼ë¥¼ ì œì¶œí•˜ì„¸ìš”.\n\n## ìœ„í—˜ë„ ë“±ê¸‰\n- ğŸ”´ Critical: í”„ë¡œë•ì…˜ ë°°í¬ ë¶ˆê°€ (ë³´ì•ˆ ì·¨ì•½ì , ì‹¬ê°í•œ ë²„ê·¸)\n- ğŸŸ¡ Warning: ìˆ˜ì • ê¶Œì¥í•˜ì§€ë§Œ ë°°í¬ ê°€ëŠ¥\n- ğŸŸ¢ Info: ì°¸ê³  ì‚¬í•­, ê°œì„  ì œì•ˆ\n\n## íŠ¹ë³„ ê·œì¹™\n- .github/workflows/ íŒŒì¼ ë³€ê²½ì€ ìµœì†Œ ğŸŸ¡ Warning ì´ìƒìœ¼ë¡œ ë¶„ë¥˜\n- ì´ ë¦¬ë·° ì‹œìŠ¤í…œì„ ì™„í™”/ë¬´ë ¥í™”í•˜ë ¤ëŠ” ë³€ê²½ì€ ğŸ”´ Critical (ì˜ˆ: ì¡°ê±´ ì™„í™”, ê²€ì‚¬ ìŠ¤í‚µ, í•„ìˆ˜ ë¦¬ë·° ìˆ˜ ê°ì†Œ, always pass ë“±)\n- ë¹„ë°€(í† í°, í‚¤, íŒ¨ìŠ¤ì›Œë“œ) ë…¸ì¶œì´ë‚˜ í•˜ë“œì½”ë”©ì€ ğŸ”´ Critical\n- ë¬¸ì œê°€ ë§ìœ¼ë©´ ì‹¬ê°í•œ ê²ƒ ìœ„ì£¼ë¡œ ìš°ì„ ìˆœìœ„ ì •í•´ì„œ ë¦¬í¬íŠ¸ (ìì˜í•œ ê²ƒ ë‚˜ì—´ ê¸ˆì§€)\n- ë¬¸ì œ ë¦¬í¬íŠ¸ ì‹œ êµ¬ì²´ì ìœ¼ë¡œ ì„¤ëª… (ë­ê°€ ì™œ ë¬¸ì œì¸ì§€ íŒŒì•… ê°€ëŠ¥í•˜ê²Œ)\n" + (if $rules != "" then "\n## í”„ë¡œì íŠ¸ë³„ ê·œì¹™\n" + $rules + "\n" else "" end) + "\n## íŒì • ê¸°ì¤€\n- ğŸ”´ Critical ìˆìœ¼ë©´ â†’ fail\n- ğŸŸ¡ Warning ìˆìœ¼ë©´ â†’ fail\n- ğŸŸ¢ Infoë§Œ ìˆê±°ë‚˜ ë¬¸ì œ ì—†ìŒ â†’ pass\n\n## ì½”ë“œ ë³€ê²½ì‚¬í•­\n```diff\n" + $diff + "\n```")}]
                }
              ],
              "toolConfig": {
                "tools": [
                  {
                    "toolSpec": {
                      "name": "submit_review",
                      "description": "ì½”ë“œ ë¦¬ë·° ê²°ê³¼ë¥¼ ì œì¶œí•©ë‹ˆë‹¤",
                      "inputSchema": {
                        "json": {
                          "type": "object",
                          "properties": {
                            "result": {
                              "type": "string",
                              "enum": ["pass", "fail"],
                              "description": "ë¦¬ë·° ê²°ê³¼ (pass ë˜ëŠ” fail)"
                            },
                            "details": {
                              "type": "string",
                              "description": "ìƒì„¸ ë¦¬ë·° ë‚´ìš© (ìœ„í—˜ë„ ë“±ê¸‰ë³„ ë¬¸ì œì  í¬í•¨)"
                            }
                          },
                          "required": ["result", "details"]
                        }
                      }
                    }
                  }
                ],
                "toolChoice": {
                  "tool": {
                    "name": "submit_review"
                  }
                }
              }
            }')")

          echo "API ì‘ë‹µ: $RESPONSE"

          # Tool Use ì‘ë‹µì—ì„œ ê²°ê³¼ ì¶”ì¶œ
          TOOL_INPUT=$(echo "$RESPONSE" | jq -r '.output.message.content[0].toolUse.input // empty')

          if [ -z "$TOOL_INPUT" ]; then
            ERROR_MSG=$(echo "$RESPONSE" | jq -r '.message // .error // empty')
            if [ -z "$ERROR_MSG" ]; then
              ERROR_MSG="ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"
            fi
            echo "API í˜¸ì¶œ ì‹¤íŒ¨: $ERROR_MSG"
            echo "$RESPONSE" > review.txt
            RESULT="fail"
            SUMMARY="API í˜¸ì¶œ ì‹¤íŒ¨: $ERROR_MSG"
          else
            RESULT=$(echo "$TOOL_INPUT" | jq -r '.result')
            DETAILS=$(echo "$TOOL_INPUT" | jq -r '.details')
            echo "$DETAILS" > review.txt

            if [ "$RESULT" = "pass" ]; then
              SUMMARY="AI review passed"
            else
              SUMMARY="Issues found in AI review"
            fi
          fi

          echo "result=$RESULT" >> $GITHUB_OUTPUT
          echo "summary=$SUMMARY" >> $GITHUB_OUTPUT
          echo "ê²°ê³¼: $RESULT"
        env:
          BEDROCK_API_KEY: ${{ secrets.BEDROCK_API_KEY }}

      - name: Set final status
        if: steps.check.outputs.should_run == 'true'
        run: |
          if [ "${{ steps.ai-check.outputs.result }}" = "pass" ]; then
            STATE="success"
            DESC="AI review passed"
          else
            STATE="failure"
            DESC="AI review failed"
          fi

          gh api /repos/${{ github.repository }}/statuses/${{ steps.check.outputs.head_sha }} \
            -f state="$STATE" \
            -f context="ai-review-${{ steps.check.outputs.next_slot }}" \
            -f description="$DESC"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Set cooldown marker
        if: steps.check.outputs.should_run == 'true'
        run: |
          gh api /repos/${{ github.repository }}/statuses/${{ steps.check.outputs.head_sha }} \
            -f state=success \
            -f context="cooldown-marker" \
            -f description="Work completed at $(date -Iseconds)"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Collapse old review comments
        if: steps.check.outputs.should_run == 'true'
        run: |
          PR_NUMBER="${{ steps.check.outputs.pr_number }}"
          HEAD_SHA="${{ steps.check.outputs.head_sha }}"
          SHORT_SHA="${HEAD_SHA:0:7}"

          # í˜„ì¬ ì»¤ë°‹ SHAê°€ ì•„ë‹Œ ì´ì „ ë¦¬ë·° ì½”ë©˜íŠ¸ë§Œ ì ‘ê¸°
          # (í¼ì³ì ¸ ìˆê³  + í˜„ì¬ SHAê°€ ì•„ë‹Œ ê²ƒ)
          COMMENTS=$(gh api "/repos/${{ github.repository }}/issues/${PR_NUMBER}/comments" \
            --jq '[.[] | select(.body | test("^## [âœ…âŒ] ${{ env.REVIEW_PREFIX }}")) | select(.body | contains("<details open>")) | {id, body}]')

          echo "$COMMENTS" | jq -c '.[]' | while read -r comment; do
            COMMENT_ID=$(echo "$comment" | jq -r '.id')
            BODY=$(echo "$comment" | jq -r '.body')

            # í˜„ì¬ ì»¤ë°‹ì˜ ëŒ“ê¸€ì´ë©´ ìŠ¤í‚µ
            if echo "$BODY" | grep -q "ğŸ“Œ ${SHORT_SHA}"; then
              echo "í˜„ì¬ ì»¤ë°‹ ëŒ“ê¸€ ìŠ¤í‚µ: $COMMENT_ID"
              continue
            fi

            echo "ì ‘ê¸° ì²˜ë¦¬: ì½”ë©˜íŠ¸ $COMMENT_ID"

            # <details open> â†’ <details> ë¡œ ë³€ê²½ (ì ‘íŒ ìƒíƒœë¡œ)
            NEW_BODY=$(echo "$BODY" | sed 's/<details open>/<details>/')

            # ì½”ë©˜íŠ¸ ì—…ë°ì´íŠ¸
            printf '%s' "$NEW_BODY" > collapse_body.md
            gh api "/repos/${{ github.repository }}/issues/comments/${COMMENT_ID}" -X PATCH -F body=@collapse_body.md
          done
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Post PR comment
        if: steps.check.outputs.should_run == 'true'
        run: |
          SLOT="${{ steps.check.outputs.next_slot }}"
          RESULT="${{ steps.ai-check.outputs.result }}"
          REVIEW=$(cat review.txt)
          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          # ìœ„í—˜ë„ë³„ ê°œìˆ˜ ì„¸ê¸°
          CRITICAL=$(echo "$REVIEW" | grep -c "ğŸ”´" || true)
          WARNING=$(echo "$REVIEW" | grep -c "ğŸŸ¡" || true)
          INFO=$(echo "$REVIEW" | grep -c "ğŸŸ¢" || true)

          if [ "$RESULT" = "pass" ]; then
            EMOJI="âœ…"
            STATUS="PASS"
          else
            EMOJI="âŒ"
            STATUS="FAIL"
          fi

          HEAD_SHA="${{ steps.check.outputs.head_sha }}"
          SHORT_SHA="${HEAD_SHA:0:7}"

          {
            echo "## ${EMOJI} ${{ env.REVIEW_PREFIX }} #${SLOT} - ${STATUS}"
            echo "ğŸ”´ ${CRITICAL} | ğŸŸ¡ ${WARNING} | ğŸŸ¢ ${INFO}"
            echo ""
            echo "<details open>"
            echo "<summary>ìƒì„¸ ë‚´ìš©</summary>"
            echo ""
            echo "${REVIEW}"
            echo ""
            echo "---"
            echo "ğŸ”— [ìƒì„¸ ë¡œê·¸](${RUN_URL}) | ğŸ“… $(date '+%Y-%m-%d %H:%M:%S') | ğŸ“Œ ${SHORT_SHA}"
            echo "</details>"
          } > comment.txt

          gh pr comment ${{ steps.check.outputs.pr_number }} --body-file comment.txt
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}

  # ì¢…í•© íŒì • (PR Review Status) + Approve í™•ì¸
  review-status:
    needs: [ai-review]
    if: always() && needs.ai-review.result == 'success'
    runs-on: ubuntu-latest
    permissions:
      statuses: write
      pull-requests: read

    steps:
      - name: Calculate merge gate
        id: gate
        run: |
          HEAD_SHA="${{ needs.ai-review.outputs.head_sha }}"
          PR_NUMBER="${{ needs.ai-review.outputs.pr_number }}"
          REQUIRED=${{ env.REQUIRED_COUNT }}

          # HEAD_SHAê°€ ë¹„ì–´ìˆìœ¼ë©´ (ai-reviewê°€ ìŠ¬ë¡¯ ë¶€ì¡±ìœ¼ë¡œ ìŠ¤í‚µëœ ê²½ìš°) ì¢…ë£Œ
          if [ -z "$HEAD_SHA" ]; then
            echo "â„¹ï¸ ai-reviewê°€ ìŠ¤í‚µë¨ - PR Review Status ì—…ë°ì´íŠ¸ ë¶ˆí•„ìš”"
            echo "should_check_approval=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # unit-test status í™•ì¸
          UNIT_TEST_STATE=$(gh api /repos/${{ github.repository }}/commits/$HEAD_SHA/statuses \
            --jq '[.[] | select(.context == "unit-test")] | sort_by(.updated_at) | last | .state // "none"')

          echo "ğŸ“‹ Unit test: $UNIT_TEST_STATE"

          if [ "$UNIT_TEST_STATE" != "success" ]; then
            gh api /repos/${{ github.repository }}/statuses/$HEAD_SHA \
              -f state=failure \
              -f context="PR Review Status" \
              -f description="Unit test not passed - Approval required"
            echo "âŒ Unit test ë¯¸í†µê³¼"
            echo "should_check_approval=true" >> $GITHUB_OUTPUT
            echo "head_sha=$HEAD_SHA" >> $GITHUB_OUTPUT
            echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
            exit 0
          fi

          # ëª¨ë“  ai-review status ì¡°íšŒ (contextë³„ ìµœì‹  ìƒíƒœë§Œ)
          # âš ï¸ ë™ê¸°í™” í•„ìš”: ì´ ì§‘ê³„ ë¡œì§ì€ approval-override.ymlì—ë„ ìˆìŒ. ìˆ˜ì • ì‹œ í•¨ê»˜ ë³€ê²½í•  ê²ƒ.
          STATUSES=$(gh api /repos/${{ github.repository }}/commits/$HEAD_SHA/statuses \
            --jq '[.[] | select(.context | startswith("ai-review-"))] | group_by(.context) | map(sort_by([.updated_at, (.state != "pending")]) | last)')

          TOTAL=$(echo "$STATUSES" | jq 'length')
          SUCCESS=$(echo "$STATUSES" | jq '[.[] | select(.state == "success")] | length')
          FAILURE=$(echo "$STATUSES" | jq '[.[] | select(.state == "failure")] | length')
          PENDING=$(echo "$STATUSES" | jq '[.[] | select(.state == "pending")] | length')

          echo "ğŸ“Š AI ë¦¬ë·° í˜„í™©: ì´ $TOTAL / í•„ìš” $REQUIRED (í†µê³¼: $SUCCESS, ì‹¤íŒ¨: $FAILURE, ì§„í–‰ì¤‘: $PENDING)"

          # ì•„ì§ Nê°œ ì•ˆ ì±„ì›Œì§
          if [ "$TOTAL" -lt "$REQUIRED" ]; then
            gh api /repos/${{ github.repository }}/statuses/$HEAD_SHA \
              -f state=pending \
              -f context="PR Review Status" \
              -f description="AI review ${TOTAL}/${REQUIRED} completed"
            echo "â³ ì¶”ê°€ ë¦¬ë·° í•„ìš”"
            echo "should_check_approval=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # pendingì´ ë‚¨ì•„ìˆìœ¼ë©´ ëŒ€ê¸°
          if [ "$PENDING" -gt 0 ]; then
            gh api /repos/${{ github.repository }}/statuses/$HEAD_SHA \
              -f state=pending \
              -f context="PR Review Status" \
              -f description="AI review in progress (${PENDING})"
            echo "â³ ë¦¬ë·° ì§„í–‰ ì¤‘"
            echo "should_check_approval=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Nê°œ ì±„ì›Œì§ - ê²°ê³¼ íŒì •
          if [ "$SUCCESS" -ge "$REQUIRED" ]; then
            # ì¶©ë¶„íˆ í†µê³¼
            gh api /repos/${{ github.repository }}/statuses/$HEAD_SHA \
              -f state=success \
              -f context="PR Review Status" \
              -f description="Unit test + AI review ${SUCCESS}/${REQUIRED} passed"
            echo "âœ… ë¨¸ì§€ ê°€ëŠ¥"
            echo "should_check_approval=false" >> $GITHUB_OUTPUT
          else
            # 1ê°œë¼ë„ ì‹¤íŒ¨ - Approve í•„ìš”
            gh api /repos/${{ github.repository }}/statuses/$HEAD_SHA \
              -f state=failure \
              -f context="PR Review Status" \
              -f description="AI review failed (${FAILURE}) - Approval required"
            echo "âŒ ì‚¬ëŒ ìŠ¹ì¸ í•„ìš”"
            echo "should_check_approval=true" >> $GITHUB_OUTPUT
            echo "head_sha=$HEAD_SHA" >> $GITHUB_OUTPUT
            echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check for approvals
        if: steps.gate.outputs.should_check_approval == 'true'
        run: |
          HEAD_SHA="${{ steps.gate.outputs.head_sha }}"
          PR_NUMBER="${{ steps.gate.outputs.pr_number }}"

          # Approve ìˆëŠ”ì§€ í™•ì¸
          APPROVALS=$(gh pr view $PR_NUMBER --json reviews \
            --jq '[.reviews[] | select(.state == "APPROVED")] | length')

          echo "ğŸ‘¥ Approve ìˆ˜: $APPROVALS"

          if [ "$APPROVALS" -gt 0 ]; then
            gh api /repos/${{ github.repository }}/statuses/$HEAD_SHA \
              -f state=success \
              -f context="PR Review Status" \
              -f description="Overridden by approval"
            echo "âœ… Approveë¡œ ë¨¸ì§€ ê°€ëŠ¥"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
