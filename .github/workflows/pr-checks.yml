name: PR Checks

on:
  # PR ìƒì„± ì‹œ ê°€ì´ë“œ ì½”ë©˜íŠ¸
  pull_request:
    types: [opened]
    branches: [main]

  # PR ì½”ë©˜íŠ¸ë¡œ ì‹¤í–‰
  issue_comment:
    types: [created]

# ë™ì¼ PRì— ëŒ€í•´ ìˆœì°¨ ì‹¤í–‰
concurrency:
  group: pr-checks-${{ github.event.pull_request.number || github.event.issue.number || github.ref }}
  cancel-in-progress: false

permissions:
  contents: read
  pull-requests: write
  statuses: write

jobs:
  # PR ìƒì„± ì‹œ ê°€ì´ë“œ ì½”ë©˜íŠ¸
  guide-comment:
    if: github.event_name == 'pull_request' && github.event.action == 'opened'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      statuses: write
    steps:
      - name: Post guide comment
        run: |
          cat > comment.md << 'GUIDE_EOF'
          ## PR Checks Guide

          ### Commands
          | Command | Description | Required |
          |---------|-------------|----------|
          | `/test` | unit-test | Yes (must pass) |
          | `/review` | ai-review | Yes |
          | `/checks` | Run all required checks | - |

          ### Merge Requirements
          All required checks must be completed, or approval is needed.
          GUIDE_EOF

          # ì• ê³µë°± ì œê±°
          sed -i 's/^          //' comment.md

          # PR ëŒ“ê¸€ ì‘ì„±
          BODY=$(jq -Rs '.' comment.md)
          curl -sf -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Content-Type: application/json" \
            -X POST "${{ github.api_url }}/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments" \
            -d "{\"body\": $BODY}"

          # ì´ˆê¸° pending status ì„¤ì •
          curl -sf -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Content-Type: application/json" \
            -X POST "${{ github.api_url }}/repos/${{ github.repository }}/statuses/${{ github.event.pull_request.head.sha }}" \
            -d '{"state":"pending","context":"PR Checks Status","description":"Waiting for checks"}'

  # íŠ¸ë¦¬ê±° ì²´í¬
  check-trigger:
    if: github.event_name == 'issue_comment'
    runs-on: ubuntu-latest
    outputs:
      should_continue: ${{ steps.check.outputs.should_continue }}
      pr_number: ${{ steps.check.outputs.pr_number }}
      head_sha: ${{ steps.check.outputs.head_sha }}
      trigger: ${{ steps.check.outputs.trigger }}
    steps:
      - name: Check trigger
        id: check
        run: |
          # PR ì½”ë©˜íŠ¸ì¸ì§€ í™•ì¸
          if [ -z "${{ github.event.issue.pull_request }}" ]; then
            echo "should_continue=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # ê¶Œí•œ í™•ì¸ (write ì´ìƒ ê¶Œí•œ í•„ìš”)
          USER="${{ github.event.comment.user.login }}"
          REPO_OWNER="${{ github.repository_owner }}"

          # GitHub: collaborators APIë¡œ ê¶Œí•œ í™•ì¸
          PERMISSION=$(curl -sf -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "${{ github.api_url }}/repos/${{ github.repository }}/collaborators/$USER/permission" \
            | jq -r '.permission' 2>/dev/null || echo "")

          if [ -z "$PERMISSION" ]; then
            echo "Failed to get permission for user $USER"
            echo "should_continue=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          if [[ ! "$PERMISSION" =~ ^(owner|admin|maintain|write)$ ]]; then
            echo "User $USER does not have write permission (got: $PERMISSION)"
            echo "should_continue=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          PR_NUMBER="${{ github.event.issue.number }}"

          # íŠ¸ë¦¬ê±° ëª…ë ¹ì–´ ë§¤ì¹­ (ì²« ì¤„ ì²« ë‹¨ì–´ë§Œ ì‚¬ìš©)
          FIRST_LINE=$(printf '%s' "${{ github.event.comment.body }}" | head -1)
          FIRST_WORD=$(echo "$FIRST_LINE" | awk '{print $1}')
          TRIGGER=""
          if [[ "$FIRST_WORD" =~ ^(\/test|\/review|\/checks)$ ]]; then
            TRIGGER="$FIRST_WORD"
          fi

          if [ -z "$TRIGGER" ]; then
            echo "should_continue=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          if [ -z "$PR_NUMBER" ]; then
            echo "should_continue=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # HEAD SHA ì¡°íšŒ
          HEAD_SHA=$(curl -sf -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "${{ github.api_url }}/repos/${{ github.repository }}/pulls/$PR_NUMBER" \
            | jq -r '.head.sha')

          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "head_sha=$HEAD_SHA" >> $GITHUB_OUTPUT
          echo "trigger=$TRIGGER" >> $GITHUB_OUTPUT
          echo "should_continue=true" >> $GITHUB_OUTPUT

  # unit-test
  unit-test:
    if: |
      needs.check-trigger.outputs.should_continue == 'true' &&
      (needs.check-trigger.outputs.trigger == '/test' || needs.check-trigger.outputs.trigger == '/checks')
    needs: [check-trigger]
    runs-on: ubuntu-latest
    steps:
      - name: Get PR branch
        id: pr-branch
        run: |
          PR_NUMBER="${{ needs.check-trigger.outputs.pr_number }}"
          BRANCH=$(curl -sf -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "${{ github.api_url }}/repos/${{ github.repository }}/pulls/$PR_NUMBER" \
            | jq -r '.head.ref')
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT

      - uses: actions/checkout@v4
        with:
          ref: ${{ steps.pr-branch.outputs.branch }}

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Run unit-test
        id: test
        shell: bash
        run: |
          set +e
          uv run pytest 2>&1 | tee test_output.txt
          EXIT_CODE=${PIPESTATUS[0]}
          if [ "$EXIT_CODE" = "0" ]; then
            echo "passed=true" >> $GITHUB_OUTPUT
          else
            echo "passed=false" >> $GITHUB_OUTPUT
          fi

      - name: Set status and post comment
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_API_URL: ${{ github.api_url }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_SERVER_URL: ${{ github.server_url }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          GITHUB_RUN_NUMBER: ${{ github.run_number }}
        run: |
          bash .pr-checks/scripts/unit-test-report.sh \
            "${{ needs.check-trigger.outputs.head_sha }}" \
            "${{ needs.check-trigger.outputs.pr_number }}" \
            "${{ steps.test.outputs.passed }}"

      - name: Collapse old comments
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_API_URL: ${{ github.api_url }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          bash .pr-checks/scripts/unit-test-collapse.sh \
            "${{ needs.check-trigger.outputs.pr_number }}" \
            "${{ needs.check-trigger.outputs.head_sha }}"

      - name: Fail if tests failed
        shell: bash
        run: |
          if [ "$(cat test_result.txt)" != "true" ]; then
            exit 1
          fi

  # ai-review
  ai-review:
    if: |
      always() &&
      needs.check-trigger.outputs.should_continue == 'true' &&
      (needs.check-trigger.outputs.trigger != '/checks' || (needs.unit-test.result == 'success')) &&
      (needs.check-trigger.outputs.trigger == '/review' || needs.check-trigger.outputs.trigger == '/checks')
    needs: [check-trigger, unit-test]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      statuses: write

    steps:
      - name: Get PR diff
        id: diff
        run: |
          PR_NUMBER="${{ needs.check-trigger.outputs.pr_number }}"
          curl -sf -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "${{ github.api_url }}/repos/${{ github.repository }}/pulls/$PR_NUMBER.diff" > diff.txt
          DIFF_SIZE=$(wc -c < diff.txt)
          echo "diff_size=$DIFF_SIZE" >> $GITHUB_OUTPUT

      - name: Set pending status
        run: |
          HEAD_SHA="${{ needs.check-trigger.outputs.head_sha }}"
          curl -sf -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Content-Type: application/json" \
            -X POST "${{ github.api_url }}/repos/${{ github.repository }}/statuses/$HEAD_SHA" \
            -d '{"state":"pending","context":"ai-review","description":"Check in progress..."}'

      - name: Run AI Review
        id: ai-check
        run: |
          echo "ğŸ¤– AI ì½”ë“œ ë¦¬ë·° ì‹¤í–‰ ì¤‘..."

          DIFF_CONTENT=$(cat diff.txt)

          # í”„ë¡œì íŠ¸ë³„ ë¦¬ë·° ê·œì¹™
          CUSTOM_RULES=""

          # Bedrock API í˜¸ì¶œ (Tool Useë¡œ êµ¬ì¡°í™”ëœ ì‘ë‹µ ê°•ì œ)
          RESPONSE=$(curl -s -X POST "https://bedrock-runtime.us-east-1.amazonaws.com/model/us.amazon.nova-micro-v1:0/converse" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.BEDROCK_API_KEY }}" \
            -d "$(jq -n --arg diff "$DIFF_CONTENT" --arg rules "$CUSTOM_RULES" '{
              "messages": [
                {
                  "role": "user",
                  "content": [{"text": ("ë‹¹ì‹ ì€ ì‹œë‹ˆì–´ ê°œë°œìì…ë‹ˆë‹¤. ì½”ë“œ ë³€ê²½ì‚¬í•­ì„ ë¦¬ë·°í•˜ê³  submit_review ë„êµ¬ë¡œ ê²°ê³¼ë¥¼ ì œì¶œí•˜ì„¸ìš”.\n\n## ìœ„í—˜ë„ ë“±ê¸‰\n- ğŸ”´ Critical: í”„ë¡œë•ì…˜ ë°°í¬ ë¶ˆê°€ (ë³´ì•ˆ ì·¨ì•½ì , ì‹¬ê°í•œ ë²„ê·¸)\n- ğŸŸ¡ Warning: ìˆ˜ì • ê¶Œì¥í•˜ì§€ë§Œ ë°°í¬ ê°€ëŠ¥\n- ğŸŸ¢ Info: ì°¸ê³  ì‚¬í•­, ê°œì„  ì œì•ˆ\n\n## íŠ¹ë³„ ê·œì¹™\n- .github/workflows/ ë˜ëŠ” .gitea/workflows/ íŒŒì¼ ë³€ê²½ì€ ìµœì†Œ ğŸŸ¡ Warning ì´ìƒìœ¼ë¡œ ë¶„ë¥˜\n- ì´ ë¦¬ë·° ì‹œìŠ¤í…œì„ ì™„í™”/ë¬´ë ¥í™”í•˜ë ¤ëŠ” ë³€ê²½ì€ ğŸ”´ Critical (ì˜ˆ: ì¡°ê±´ ì™„í™”, ê²€ì‚¬ ìŠ¤í‚µ, í•„ìˆ˜ ë¦¬ë·° ìˆ˜ ê°ì†Œ, always pass ë“±)\n- CUSTOM_REVIEW_RULES í™˜ê²½ë³€ìˆ˜ ë³€ê²½ì€ ğŸ”´ Critical (ë¦¬ë·° ê·œì¹™ ì¡°ì‘ ì‹œë„ ê°€ëŠ¥ì„±)\n- ë¹„ë°€(í† í°, í‚¤, íŒ¨ìŠ¤ì›Œë“œ) ë…¸ì¶œì´ë‚˜ í•˜ë“œì½”ë”©ì€ ğŸ”´ Critical\n- ë¬¸ì œê°€ ë§ìœ¼ë©´ ì‹¬ê°í•œ ê²ƒ ìœ„ì£¼ë¡œ ìš°ì„ ìˆœìœ„ ì •í•´ì„œ ë¦¬í¬íŠ¸ (ìì˜í•œ ê²ƒ ë‚˜ì—´ ê¸ˆì§€)\n- ë¬¸ì œ ë¦¬í¬íŠ¸ ì‹œ êµ¬ì²´ì ìœ¼ë¡œ ì„¤ëª… (ë­ê°€ ì™œ ë¬¸ì œì¸ì§€ íŒŒì•… ê°€ëŠ¥í•˜ê²Œ)\n" + (if $rules != "" then "\n## í”„ë¡œì íŠ¸ë³„ ê·œì¹™\n" + $rules + "\n" else "" end) + "\n## íŒì • ê¸°ì¤€\n- ğŸ”´ Critical ìˆìœ¼ë©´ â†’ fail\n- ğŸŸ¡ Warning ìˆìœ¼ë©´ â†’ fail\n- ğŸŸ¢ Infoë§Œ ìˆê±°ë‚˜ ë¬¸ì œ ì—†ìŒ â†’ pass\n\n## ì½”ë“œ ë³€ê²½ì‚¬í•­\n```diff\n" + $diff + "\n```")}]
                }
              ],
              "toolConfig": {
                "tools": [
                  {
                    "toolSpec": {
                      "name": "submit_review",
                      "description": "ì½”ë“œ ë¦¬ë·° ê²°ê³¼ë¥¼ ì œì¶œí•©ë‹ˆë‹¤",
                      "inputSchema": {
                        "json": {
                          "type": "object",
                          "properties": {
                            "result": {
                              "type": "string",
                              "enum": ["pass", "fail"],
                              "description": "ë¦¬ë·° ê²°ê³¼ (pass ë˜ëŠ” fail)"
                            },
                            "details": {
                              "type": "string",
                              "description": "ìƒì„¸ ë¦¬ë·° ë‚´ìš© (ìœ„í—˜ë„ ë“±ê¸‰ë³„ ë¬¸ì œì  í¬í•¨)"
                            }
                          },
                          "required": ["result", "details"]
                        }
                      }
                    }
                  }
                ],
                "toolChoice": {
                  "tool": {
                    "name": "submit_review"
                  }
                }
              }
            }')")

          # Tool Use ì‘ë‹µì—ì„œ ê²°ê³¼ ì¶”ì¶œ
          TOOL_INPUT=$(echo "$RESPONSE" | jq -r '.output.message.content[0].toolUse.input // empty')

          if [ -z "$TOOL_INPUT" ]; then
            ERROR_MSG=$(echo "$RESPONSE" | jq -r '.message // .error // empty')
            if [ -z "$ERROR_MSG" ]; then
              ERROR_MSG="ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"
            fi
            echo "API í˜¸ì¶œ ì‹¤íŒ¨: $ERROR_MSG"
            echo "$RESPONSE" > review.txt
            RESULT="fail"
            SUMMARY="API í˜¸ì¶œ ì‹¤íŒ¨: $ERROR_MSG"
          else
            RESULT=$(echo "$TOOL_INPUT" | jq -r '.result')
            DETAILS=$(echo "$TOOL_INPUT" | jq -r '.details')
            echo "$DETAILS" > review.txt

            if [ "$RESULT" = "pass" ]; then
              SUMMARY="AI review passed"
            else
              SUMMARY="Issues found in AI review"
            fi
          fi

          echo "result=$RESULT" >> $GITHUB_OUTPUT
          echo "summary=$SUMMARY" >> $GITHUB_OUTPUT
        env:
          BEDROCK_API_KEY: ${{ secrets.BEDROCK_API_KEY }}

      - name: Set final status
        run: |
          HEAD_SHA="${{ needs.check-trigger.outputs.head_sha }}"

          if [ "${{ steps.ai-check.outputs.result }}" = "pass" ]; then
            STATE="success"
            DESC="Check passed"
          else
            STATE="failure"
            DESC="Check failed"
          fi

          curl -sf -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Content-Type: application/json" \
            -X POST "${{ github.api_url }}/repos/${{ github.repository }}/statuses/$HEAD_SHA" \
            -d "{\"state\":\"$STATE\",\"context\":\"ai-review\",\"description\":\"$DESC\"}"

      - name: Collapse old review comments
        run: |
          PR_NUMBER="${{ needs.check-trigger.outputs.pr_number }}"
          HEAD_SHA="${{ needs.check-trigger.outputs.head_sha }}"
          SHORT_SHA="${HEAD_SHA:0:7}"

          # í˜„ì¬ ì»¤ë°‹ SHAê°€ ì•„ë‹Œ ì´ì „ ë¦¬ë·° ì½”ë©˜íŠ¸ë§Œ ì ‘ê¸°
          # (í¼ì³ì ¸ ìˆê³  + í˜„ì¬ SHAê°€ ì•„ë‹Œ ê²ƒ)
          COMMENTS=$(curl -sf -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "${{ github.api_url }}/repos/${{ github.repository }}/issues/${PR_NUMBER}/comments" \
            | jq '[.[] | select(.body | test("^## [âœ…âŒ] ai-review")) | select(.body | contains("<details open>")) | {id, body}]')

          echo "$COMMENTS" | jq -c '.[]' | while read -r comment; do
            COMMENT_ID=$(echo "$comment" | jq -r '.id')
            BODY=$(echo "$comment" | jq -r '.body')

            # í˜„ì¬ ì»¤ë°‹ì˜ ëŒ“ê¸€ì´ë©´ ìŠ¤í‚µ
            if echo "$BODY" | grep -q "ğŸ“Œ ${SHORT_SHA}"; then
              echo "í˜„ì¬ ì»¤ë°‹ ëŒ“ê¸€ ìŠ¤í‚µ: $COMMENT_ID"
              continue
            fi

            echo "ì ‘ê¸° ì²˜ë¦¬: ì½”ë©˜íŠ¸ $COMMENT_ID"

            # <details open> â†’ <details> ë¡œ ë³€ê²½ (ì ‘íŒ ìƒíƒœë¡œ)
            NEW_BODY=$(echo "$BODY" | sed 's/<details open>/<details>/')

            # ì½”ë©˜íŠ¸ ì—…ë°ì´íŠ¸
            printf '%s' "$NEW_BODY" > collapse_body.md
            PATCH_BODY=$(jq -Rs '.' collapse_body.md)
            curl -sf -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Content-Type: application/json" \
              -X PATCH "${{ github.api_url }}/repos/${{ github.repository }}/issues/comments/${COMMENT_ID}" \
              -d "{\"body\": $PATCH_BODY}"
          done

      - name: Post PR comment
        run: |
          RESULT="${{ steps.ai-check.outputs.result }}"
          REVIEW=$(cat review.txt)

          # GitHub uses run_id in URL, Gitea uses run_number
          # Note: Gitea's github.run_number incorrectly returns run_id, so we query API
          if [[ "${{ github.server_url }}" == *"github.com"* ]]; then
            RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          else
            # Gitea: Query API to get correct run_number from run_id
            ACTUAL_RUN_NUMBER=$(curl -sf -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              "${{ github.api_url }}/repos/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
              | jq -r '.run_number // empty' 2>/dev/null)
            if [ -n "$ACTUAL_RUN_NUMBER" ]; then
              RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/$ACTUAL_RUN_NUMBER"
            else
              RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            fi
          fi

          # ìœ„í—˜ë„ë³„ ê°œìˆ˜ ì„¸ê¸°
          CRITICAL=$(echo "$REVIEW" | grep -c "ğŸ”´" || true)
          WARNING=$(echo "$REVIEW" | grep -c "ğŸŸ¡" || true)
          INFO=$(echo "$REVIEW" | grep -c "ğŸŸ¢" || true)

          if [ "$RESULT" = "pass" ]; then
            EMOJI="âœ…"
            STATUS="PASS"
          else
            EMOJI="âŒ"
            STATUS="FAIL"
          fi

          HEAD_SHA="${{ needs.check-trigger.outputs.head_sha }}"
          SHORT_SHA="${HEAD_SHA:0:7}"

          {
            echo "## ${EMOJI} ai-review - ${STATUS}"
            echo "ğŸ”´ ${CRITICAL} | ğŸŸ¡ ${WARNING} | ğŸŸ¢ ${INFO}"
            echo ""
            echo "<details open>"
            echo "<summary>ìƒì„¸ ë‚´ìš©</summary>"
            echo ""
            echo "${REVIEW}"
            echo ""
            echo "---"
            echo "ğŸ”— [ìƒì„¸ ë¡œê·¸](${RUN_URL}) | ğŸ“… $(date '+%Y-%m-%d %H:%M:%S') | ğŸ“Œ ${SHORT_SHA}"
            echo ""
            echo "ğŸ¤– Model: \`us.amazon.nova-micro-v1:0\` | \`/review\` ëª…ë ¹ì— ëŒ€í•œ ì‘ë‹µ"
            echo "</details>"
          } > comment.txt

          BODY=$(jq -Rs '.' comment.txt)
          curl -sf -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Content-Type: application/json" \
            -X POST "${{ github.api_url }}/repos/${{ github.repository }}/issues/${{ needs.check-trigger.outputs.pr_number }}/comments" \
            -d "{\"body\": $BODY}"

  # ì¢…í•© íŒì • (PR Checks Status)
  review-status:
    needs: [check-trigger, unit-test, ai-review]
    if: always() && needs.check-trigger.outputs.should_continue == 'true'
    runs-on: ubuntu-latest
    permissions:
      statuses: write
      pull-requests: read

    steps:
      - name: Calculate merge gate
        id: gate
        run: |
          HEAD_SHA="${{ needs.check-trigger.outputs.head_sha }}"
          PR_NUMBER="${{ needs.check-trigger.outputs.pr_number }}"
          GATE_FAILED="false"
          FAILURE_REASON=""

          # unit-test: must pass
          UNIT_TEST_STATE=$(curl -sf -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "${{ github.api_url }}/repos/${{ github.repository }}/commits/$HEAD_SHA/statuses" \
            | jq -r '[.[] | select(.context == "unit-test")] | sort_by(.updated_at) | last | .state // "none"')
          echo "unit-test: $UNIT_TEST_STATE"
          if [ "$UNIT_TEST_STATE" != "success" ]; then
            GATE_FAILED="true"
            FAILURE_REASON="unit-test not passed"
          fi

          # ai-review: must run (any result)
          AI_REVIEW_STATE=$(curl -sf -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "${{ github.api_url }}/repos/${{ github.repository }}/commits/$HEAD_SHA/statuses" \
            | jq -r '[.[] | select(.context == "ai-review")] | sort_by(.updated_at) | last | .state // "none"')
          echo "ai-review: $AI_REVIEW_STATE"
          if [ "$AI_REVIEW_STATE" = "none" ] || [ "$AI_REVIEW_STATE" = "pending" ]; then
            GATE_FAILED="true"
            FAILURE_REASON="ai-review not completed"
          fi

          if [ "$GATE_FAILED" = "true" ]; then
            curl -sf -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Content-Type: application/json" \
              -X POST "${{ github.api_url }}/repos/${{ github.repository }}/statuses/$HEAD_SHA" \
              -d '{"state":"failure","context":"PR Checks Status","description":"Approval required"}'
            echo "âŒ $FAILURE_REASON"
            echo "should_check_approval=true" >> $GITHUB_OUTPUT
            echo "head_sha=$HEAD_SHA" >> $GITHUB_OUTPUT
            echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          else
            curl -sf -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Content-Type: application/json" \
              -X POST "${{ github.api_url }}/repos/${{ github.repository }}/statuses/$HEAD_SHA" \
              -d '{"state":"success","context":"PR Checks Status","description":"All required checks passed"}'
            echo "âœ… ë¨¸ì§€ ê°€ëŠ¥"
            echo "should_check_approval=false" >> $GITHUB_OUTPUT
          fi

      - name: Check for approvals
        if: steps.gate.outputs.should_check_approval == 'true'
        run: |
          HEAD_SHA="${{ steps.gate.outputs.head_sha }}"
          PR_NUMBER="${{ steps.gate.outputs.pr_number }}"

          # Approve ìˆëŠ”ì§€ í™•ì¸
          APPROVALS=$(curl -sf -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "${{ github.api_url }}/repos/${{ github.repository }}/pulls/$PR_NUMBER/reviews" \
            | jq '[.[] | select(.state == "APPROVED")] | length')

          echo "ğŸ‘¥ Approve ìˆ˜: $APPROVALS"

          if [ "$APPROVALS" -gt 0 ]; then
            curl -sf -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Content-Type: application/json" \
              -X POST "${{ github.api_url }}/repos/${{ github.repository }}/statuses/$HEAD_SHA" \
              -d '{"state":"success","context":"PR Checks Status","description":"Overridden by approval"}'
            echo "âœ… Approveë¡œ ë¨¸ì§€ ê°€ëŠ¥"
          fi
