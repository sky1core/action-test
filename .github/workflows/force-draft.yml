name: Force Draft PR

on:
  pull_request:
    types: [opened]

jobs:
  convert-to-draft:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write

    # 이미 드래프트면 스킵
    if: github.event.pull_request.draft == false

    steps:
      - name: Convert to Draft
        run: |
          echo "PR #${{ github.event.pull_request.number }}를 드래프트로 전환합니다."

          gh api graphql -f query='
            mutation($id: ID!) {
              convertPullRequestToDraft(input: {pullRequestId: $id}) {
                pullRequest {
                  isDraft
                }
              }
            }
          ' -f id="${{ github.event.pull_request.node_id }}"

          echo "✅ 드래프트로 전환 완료"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Post comment
        run: |
          gh pr comment ${{ github.event.pull_request.number }} --body "
          ## 📋 PR이 드래프트로 전환되었습니다

          **AI 코드 검사 프로세스:**
          1. 개발 완료 후 **Ready for review** 버튼을 클릭하세요
          2. AI 검사가 자동으로 실행됩니다
          3. 머지하려면 **${{ vars.AI_REVIEW_REQUIRED_COUNT || 3 }}개**의 AI 검사 통과가 필요합니다
          4. 수동으로 추가 검사: Actions 탭에서 **AI Code Review** 워크플로우 실행

          > 💡 드래프트 상태에서는 push해도 검사가 실행되지 않아 비용이 절감됩니다.
          "
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
