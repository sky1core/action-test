name: Approval Override

on:
  pull_request_review:
    types: [submitted]

jobs:
  override-gate:
    if: github.event.review.state == 'approved'
    runs-on: ubuntu-latest
    permissions:
      statuses: write
      pull-requests: read

    steps:
      - name: Override merge-gate if needed
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"

          echo "ğŸ” PR #$PR_NUMBER ì— Approveê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤."

          # í˜„ì¬ merge-gate ìƒíƒœ í™•ì¸
          GATE_STATUS=$(gh api /repos/${{ github.repository }}/commits/$HEAD_SHA/statuses \
            --jq '[.[] | select(.context == "merge-gate")] | .[0]')

          GATE_STATE=$(echo "$GATE_STATUS" | jq -r '.state // "none"')

          echo "í˜„ì¬ merge-gate ìƒíƒœ: $GATE_STATE"

          # ì‹¤íŒ¨ ìƒíƒœë©´ override
          if [ "$GATE_STATE" = "failure" ]; then
            gh api /repos/${{ github.repository }}/statuses/$HEAD_SHA \
              -f state=success \
              -f context="merge-gate" \
              -f description="ì‚¬ëŒ ìŠ¹ì¸ìœ¼ë¡œ override (@${{ github.event.review.user.login }})"

            gh pr comment $PR_NUMBER --body "## âœ… Merge Gate Override

**@${{ github.event.review.user.login }}**ì˜ ìŠ¹ì¸ìœ¼ë¡œ AI ê²€ì‚¬ ì‹¤íŒ¨ê°€ override ë˜ì—ˆìŠµë‹ˆë‹¤.

ë¨¸ì§€ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.
"
            echo "âœ… Override ì™„ë£Œ"
          else
            echo "â„¹ï¸ Override ë¶ˆí•„ìš” (ìƒíƒœ: $GATE_STATE)"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
