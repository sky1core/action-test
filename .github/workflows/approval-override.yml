name: Approval Override

on:
  pull_request_review:
    types: [submitted, dismissed]

env:
  REQUIRED_COUNT: 2

jobs:
  # Approve Ï∂îÍ∞Ä Ïãú override
  # ‚ö†Ô∏è ÎèôÍ∏∞Ìôî ÌïÑÏöî: ÎåÄÏÉÅ Î∏åÎûúÏπò(main/master)Îäî pr-review.ymlÏùò branchesÏôÄ Ìï®Íªò Î≥ÄÍ≤ΩÌï† Í≤É.
  override-gate:
    if: |
      github.event.action == 'submitted' &&
      github.event.review.state == 'approved' &&
      (github.event.pull_request.base.ref == 'main' || github.event.pull_request.base.ref == 'master')
    runs-on: ubuntu-latest
    permissions:
      statuses: write
      pull-requests: write

    steps:
      - name: Override merge-gate if needed
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"

          echo "üîç PR #$PR_NUMBER Ïóê ApproveÍ∞Ä Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§."

          # ÌòÑÏû¨ merge-gate ÏÉÅÌÉú ÌôïÏù∏
          GATE_STATUS=$(gh api /repos/${{ github.repository }}/commits/$HEAD_SHA/statuses \
            --jq '[.[] | select(.context == "merge-gate")] | .[0]')

          GATE_STATE=$(echo "$GATE_STATUS" | jq -r '.state // "none"')

          echo "ÌòÑÏû¨ merge-gate ÏÉÅÌÉú: $GATE_STATE"

          # successÍ∞Ä ÏïÑÎãàÎ©¥ override (pending, failure Î™®Îëê)
          if [ "$GATE_STATE" != "success" ]; then
            gh api /repos/${{ github.repository }}/statuses/$HEAD_SHA \
              -f state=success \
              -f context="merge-gate" \
              -f description="ÏÇ¨Îûå ÏäπÏù∏ÏúºÎ°ú override (@${{ github.event.review.user.login }})"

            printf '## ‚úÖ Merge Gate Override\n\n**@%s**Ïùò ÏäπÏù∏ÏúºÎ°ú AI Î¶¨Î∑∞ Ïã§Ìå®Í∞Ä override ÎêòÏóàÏäµÎãàÎã§.\n\nÎ®∏ÏßÄÍ∞Ä Í∞ÄÎä•Ìï©ÎãàÎã§.' "${{ github.event.review.user.login }}" > comment.md
            gh pr comment $PR_NUMBER --body-file comment.md
            echo "‚úÖ Override ÏôÑÎ£å"
          else
            echo "‚ÑπÔ∏è Override Î∂àÌïÑÏöî (ÏÉÅÌÉú: $GATE_STATE)"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}

  # Approve Ï∑®ÏÜå Ïãú ÏõêÎûò ÏÉÅÌÉúÎ°ú Î≥µÏõê
  # ‚ö†Ô∏è ÎèôÍ∏∞Ìôî ÌïÑÏöî: ÎåÄÏÉÅ Î∏åÎûúÏπò(main/master)Îäî pr-review.ymlÏùò branchesÏôÄ Ìï®Íªò Î≥ÄÍ≤ΩÌï† Í≤É.
  restore-gate:
    if: |
      github.event.action == 'dismissed' &&
      (github.event.pull_request.base.ref == 'main' || github.event.pull_request.base.ref == 'master')
    runs-on: ubuntu-latest
    permissions:
      statuses: write
      pull-requests: write

    steps:
      - name: Restore merge-gate if needed
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"

          echo "üîç PR #$PR_NUMBER ÏóêÏÑú Î¶¨Î∑∞Í∞Ä Ï∑®ÏÜåÎêòÏóàÏäµÎãàÎã§."

          # ÎÇ®ÏùÄ Approve Ïàò ÌôïÏù∏
          APPROVALS=$(gh pr view $PR_NUMBER --json reviews \
            --jq '[.reviews[] | select(.state == "APPROVED")] | length')

          echo "ÎÇ®ÏùÄ Approve Ïàò: $APPROVALS"

          # ApproveÍ∞Ä ÎÇ®ÏïÑÏûàÏúºÎ©¥ Î≥µÏõê Î∂àÌïÑÏöî
          if [ "$APPROVALS" -gt 0 ]; then
            echo "‚ÑπÔ∏è Îã§Î•∏ ApproveÍ∞Ä ÏûàÏñ¥ÏÑú Î≥µÏõê Î∂àÌïÑÏöî"
            exit 0
          fi

          # ÌòÑÏû¨ merge-gate ÏÉÅÌÉú ÌôïÏù∏
          GATE_STATUS=$(gh api /repos/${{ github.repository }}/commits/$HEAD_SHA/statuses \
            --jq '[.[] | select(.context == "merge-gate")] | .[0]')

          GATE_STATE=$(echo "$GATE_STATUS" | jq -r '.state // "none"')
          GATE_DESC=$(echo "$GATE_STATUS" | jq -r '.description // ""')

          echo "ÌòÑÏû¨ merge-gate ÏÉÅÌÉú: $GATE_STATE"
          echo "ÌòÑÏû¨ merge-gate ÏÑ§Î™Ö: $GATE_DESC"

          # overrideÎ°ú successÍ∞Ä Îêú ÏÉÅÌÉúÏù∏ÏßÄ ÌôïÏù∏
          if [ "$GATE_STATE" != "success" ]; then
            echo "‚ÑπÔ∏è Î≥µÏõê Î∂àÌïÑÏöî (ÏÉÅÌÉú: $GATE_STATE)"
            exit 0
          fi

          # ‚ö†Ô∏è ÏùòÏ°¥ÏÑ±: descriptionÏóê "override" Ìè¨Ìï® Ïó¨Î∂ÄÎ°ú ÌåêÎã®
          # pr-review.ymlÏùò check-approvalÍ≥º Ïù¥ ÌååÏùºÏùò override-gate Î™®Îëê "override" Ìè¨Ìï®Ìï¥Ïïº Ìï®
          if [[ "$GATE_DESC" != *"override"* ]]; then
            echo "‚ÑπÔ∏è Î≥µÏõê Î∂àÌïÑÏöî (Î¶¨Î∑∞ ÌÜµÍ≥ºÎ°ú successÎê®)"
            exit 0
          fi

          # AI Î¶¨Î∑∞ Í≤∞Í≥º Îã§Ïãú Í≥ÑÏÇ∞ (contextÎ≥Ñ ÏµúÏã† ÏÉÅÌÉúÎßå)
          # ‚ö†Ô∏è ÎèôÍ∏∞Ìôî ÌïÑÏöî: Ïù¥ ÏßëÍ≥Ñ Î°úÏßÅÏùÄ pr-review.ymlÏóêÎèÑ ÏûàÏùå. ÏàòÏ†ï Ïãú Ìï®Íªò Î≥ÄÍ≤ΩÌï† Í≤É.
          STATUSES=$(gh api /repos/${{ github.repository }}/commits/$HEAD_SHA/statuses \
            --jq '[.[] | select(.context | startswith("ai-review-"))] | group_by(.context) | map(sort_by([.updated_at, (.state != "pending")]) | last)')

          TOTAL=$(echo "$STATUSES" | jq 'length')
          FAILURE=$(echo "$STATUSES" | jq '[.[] | select(.state == "failure")] | length')

          echo "Î¶¨Î∑∞ ÌòÑÌô©: Ï¥ù $TOTAL, Ïã§Ìå® $FAILURE"

          # Ïã§Ìå®Í∞Ä ÏûàÏúºÎ©¥ Îã§Ïãú failureÎ°ú
          if [ "$FAILURE" -gt 0 ]; then
            gh api /repos/${{ github.repository }}/statuses/$HEAD_SHA \
              -f state=failure \
              -f context="merge-gate" \
              -f description="AI Î¶¨Î∑∞ Ïã§Ìå® ${FAILURE}Í∞ú - Approve ÌïÑÏöî"

            printf '## ‚ö†Ô∏è Merge Gate Î≥µÏõê\n\nApproveÍ∞Ä Ï∑®ÏÜåÎêòÏñ¥ merge-gateÍ∞Ä Îã§Ïãú failure ÏÉÅÌÉúÍ∞Ä ÎêòÏóàÏäµÎãàÎã§.\n\nÎ®∏ÏßÄÌïòÎ†§Î©¥ Îã§Ïãú ApproveÍ∞Ä ÌïÑÏöîÌï©ÎãàÎã§.' > comment.md
            gh pr comment $PR_NUMBER --body-file comment.md
            echo "‚ö†Ô∏è merge-gateÎ•º failureÎ°ú Î≥µÏõê"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
