name: Approval Override

on:
  pull_request_review:
    types: [submitted, dismissed]

env:
  REQUIRED_COUNT: ${{ vars.AI_REVIEW_REQUIRED_COUNT || 3 }}

jobs:
  # Approve ì¶”ê°€ ì‹œ override
  override-gate:
    if: github.event.action == 'submitted' && github.event.review.state == 'approved'
    runs-on: ubuntu-latest
    permissions:
      statuses: write
      pull-requests: read

    steps:
      - name: Override merge-gate if needed
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"

          echo "ğŸ” PR #$PR_NUMBER ì— Approveê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤."

          # í˜„ì¬ merge-gate ìƒíƒœ í™•ì¸
          GATE_STATUS=$(gh api /repos/${{ github.repository }}/commits/$HEAD_SHA/statuses \
            --jq '[.[] | select(.context == "merge-gate")] | .[0]')

          GATE_STATE=$(echo "$GATE_STATUS" | jq -r '.state // "none"')

          echo "í˜„ì¬ merge-gate ìƒíƒœ: $GATE_STATE"

          # ì‹¤íŒ¨ ìƒíƒœë©´ override
          if [ "$GATE_STATE" = "failure" ]; then
            gh api /repos/${{ github.repository }}/statuses/$HEAD_SHA \
              -f state=success \
              -f context="merge-gate" \
              -f description="ì‚¬ëŒ ìŠ¹ì¸ìœ¼ë¡œ override (@${{ github.event.review.user.login }})"

            gh pr comment $PR_NUMBER --body "## âœ… Merge Gate Override

**@${{ github.event.review.user.login }}**ì˜ ìŠ¹ì¸ìœ¼ë¡œ AI ê²€ì‚¬ ì‹¤íŒ¨ê°€ override ë˜ì—ˆìŠµë‹ˆë‹¤.

ë¨¸ì§€ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.
"
            echo "âœ… Override ì™„ë£Œ"
          else
            echo "â„¹ï¸ Override ë¶ˆí•„ìš” (ìƒíƒœ: $GATE_STATE)"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Approve ì·¨ì†Œ ì‹œ ì›ë˜ ìƒíƒœë¡œ ë³µì›
  restore-gate:
    if: github.event.action == 'dismissed'
    runs-on: ubuntu-latest
    permissions:
      statuses: write
      pull-requests: read

    steps:
      - name: Restore merge-gate if needed
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"

          echo "ğŸ” PR #$PR_NUMBER ì—ì„œ ë¦¬ë·°ê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤."

          # ë‚¨ì€ Approve ìˆ˜ í™•ì¸
          APPROVALS=$(gh pr view $PR_NUMBER --json reviews \
            --jq '[.reviews[] | select(.state == "APPROVED")] | length')

          echo "ë‚¨ì€ Approve ìˆ˜: $APPROVALS"

          # Approveê°€ ë‚¨ì•„ìˆìœ¼ë©´ ë³µì› ë¶ˆí•„ìš”
          if [ "$APPROVALS" -gt 0 ]; then
            echo "â„¹ï¸ ë‹¤ë¥¸ Approveê°€ ìˆì–´ì„œ ë³µì› ë¶ˆí•„ìš”"
            exit 0
          fi

          # í˜„ì¬ merge-gate ìƒíƒœ í™•ì¸
          GATE_STATUS=$(gh api /repos/${{ github.repository }}/commits/$HEAD_SHA/statuses \
            --jq '[.[] | select(.context == "merge-gate")] | .[0]')

          GATE_STATE=$(echo "$GATE_STATUS" | jq -r '.state // "none"')
          GATE_DESC=$(echo "$GATE_STATUS" | jq -r '.description // ""')

          echo "í˜„ì¬ merge-gate ìƒíƒœ: $GATE_STATE"
          echo "í˜„ì¬ merge-gate ì„¤ëª…: $GATE_DESC"

          # overrideë¡œ successê°€ ëœ ìƒíƒœì¸ì§€ í™•ì¸
          if [ "$GATE_STATE" != "success" ]; then
            echo "â„¹ï¸ ë³µì› ë¶ˆí•„ìš” (ìƒíƒœ: $GATE_STATE)"
            exit 0
          fi

          if [[ "$GATE_DESC" != *"override"* ]]; then
            echo "â„¹ï¸ ë³µì› ë¶ˆí•„ìš” (ê²€ì‚¬ í†µê³¼ë¡œ successë¨)"
            exit 0
          fi

          # AI ê²€ì‚¬ ê²°ê³¼ ë‹¤ì‹œ ê³„ì‚° (contextë³„ ìµœì‹  ìƒíƒœë§Œ)
          STATUSES=$(gh api /repos/${{ github.repository }}/commits/$HEAD_SHA/statuses \
            --jq '[.[] | select(.context | startswith("ai-review-"))] | group_by(.context) | map(sort_by(.state == "pending") | .[0])')

          TOTAL=$(echo "$STATUSES" | jq 'length')
          FAILURE=$(echo "$STATUSES" | jq '[.[] | select(.state == "failure")] | length')

          echo "ê²€ì‚¬ í˜„í™©: ì´ $TOTAL, ì‹¤íŒ¨ $FAILURE"

          # ì‹¤íŒ¨ê°€ ìˆìœ¼ë©´ ë‹¤ì‹œ failureë¡œ
          if [ "$FAILURE" -gt 0 ]; then
            gh api /repos/${{ github.repository }}/statuses/$HEAD_SHA \
              -f state=failure \
              -f context="merge-gate" \
              -f description="AI ê²€ì‚¬ ì‹¤íŒ¨ ${FAILURE}ê°œ - Approve í•„ìš”"

            gh pr comment $PR_NUMBER --body "## âš ï¸ Merge Gate ë³µì›

Approveê°€ ì·¨ì†Œë˜ì–´ merge-gateê°€ ë‹¤ì‹œ failure ìƒíƒœê°€ ë˜ì—ˆìŠµë‹ˆë‹¤.

ë¨¸ì§€í•˜ë ¤ë©´ ë‹¤ì‹œ Approveê°€ í•„ìš”í•©ë‹ˆë‹¤.
"
            echo "âš ï¸ merge-gateë¥¼ failureë¡œ ë³µì›"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
