name: Approval Override

on:
  pull_request_review:
    types: [submitted, dismissed]

env:
  REQUIRED_COUNT: 3

jobs:
  # Approve ì¶”ê°€ ì‹œ override
  # âš ï¸ ë™ê¸°í™” í•„ìš”: ëŒ€ìƒ ë¸Œëžœì¹˜(main/master)ëŠ” ai-review.ymlì˜ branchesì™€ í•¨ê»˜ ë³€ê²½í•  ê²ƒ.
  override-gate:
    if: |
      github.event.action == 'submitted' &&
      github.event.review.state == 'approved' &&
      (github.event.pull_request.base.ref == 'main' || github.event.pull_request.base.ref == 'master')
    runs-on: ubuntu-latest
    permissions:
      statuses: write
      pull-requests: write

    steps:
      - name: Override merge-gate if needed
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"

          echo "ðŸ” PR #$PR_NUMBER ì— Approveê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤."

          # í˜„ìž¬ merge-gate ìƒíƒœ í™•ì¸
          GATE_STATUS=$(gh api /repos/${{ github.repository }}/commits/$HEAD_SHA/statuses \
            --jq '[.[] | select(.context == "merge-gate")] | .[0]')

          GATE_STATE=$(echo "$GATE_STATUS" | jq -r '.state // "none"')

          echo "í˜„ìž¬ merge-gate ìƒíƒœ: $GATE_STATE"

          # successê°€ ì•„ë‹ˆë©´ override (pending, failure ëª¨ë‘)
          if [ "$GATE_STATE" != "success" ]; then
            gh api /repos/${{ github.repository }}/statuses/$HEAD_SHA \
              -f state=success \
              -f context="merge-gate" \
              -f description="ì‚¬ëžŒ ìŠ¹ì¸ìœ¼ë¡œ override (@${{ github.event.review.user.login }})"

            cat > comment.md << 'EOF'
## âœ… Merge Gate Override

**@${{ github.event.review.user.login }}**ì˜ ìŠ¹ì¸ìœ¼ë¡œ AI ë¦¬ë·° ì‹¤íŒ¨ê°€ override ë˜ì—ˆìŠµë‹ˆë‹¤.

ë¨¸ì§€ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.
EOF
            gh pr comment $PR_NUMBER --body-file comment.md
            echo "âœ… Override ì™„ë£Œ"
          else
            echo "â„¹ï¸ Override ë¶ˆí•„ìš” (ìƒíƒœ: $GATE_STATE)"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}

  # Approve ì·¨ì†Œ ì‹œ ì›ëž˜ ìƒíƒœë¡œ ë³µì›
  # âš ï¸ ë™ê¸°í™” í•„ìš”: ëŒ€ìƒ ë¸Œëžœì¹˜(main/master)ëŠ” ai-review.ymlì˜ branchesì™€ í•¨ê»˜ ë³€ê²½í•  ê²ƒ.
  restore-gate:
    if: |
      github.event.action == 'dismissed' &&
      (github.event.pull_request.base.ref == 'main' || github.event.pull_request.base.ref == 'master')
    runs-on: ubuntu-latest
    permissions:
      statuses: write
      pull-requests: write

    steps:
      - name: Restore merge-gate if needed
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"

          echo "ðŸ” PR #$PR_NUMBER ì—ì„œ ë¦¬ë·°ê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤."

          # ë‚¨ì€ Approve ìˆ˜ í™•ì¸
          APPROVALS=$(gh pr view $PR_NUMBER --json reviews \
            --jq '[.reviews[] | select(.state == "APPROVED")] | length')

          echo "ë‚¨ì€ Approve ìˆ˜: $APPROVALS"

          # Approveê°€ ë‚¨ì•„ìžˆìœ¼ë©´ ë³µì› ë¶ˆí•„ìš”
          if [ "$APPROVALS" -gt 0 ]; then
            echo "â„¹ï¸ ë‹¤ë¥¸ Approveê°€ ìžˆì–´ì„œ ë³µì› ë¶ˆí•„ìš”"
            exit 0
          fi

          # í˜„ìž¬ merge-gate ìƒíƒœ í™•ì¸
          GATE_STATUS=$(gh api /repos/${{ github.repository }}/commits/$HEAD_SHA/statuses \
            --jq '[.[] | select(.context == "merge-gate")] | .[0]')

          GATE_STATE=$(echo "$GATE_STATUS" | jq -r '.state // "none"')
          GATE_DESC=$(echo "$GATE_STATUS" | jq -r '.description // ""')

          echo "í˜„ìž¬ merge-gate ìƒíƒœ: $GATE_STATE"
          echo "í˜„ìž¬ merge-gate ì„¤ëª…: $GATE_DESC"

          # overrideë¡œ successê°€ ëœ ìƒíƒœì¸ì§€ í™•ì¸
          if [ "$GATE_STATE" != "success" ]; then
            echo "â„¹ï¸ ë³µì› ë¶ˆí•„ìš” (ìƒíƒœ: $GATE_STATE)"
            exit 0
          fi

          # âš ï¸ ì˜ì¡´ì„±: descriptionì— "override" í¬í•¨ ì—¬ë¶€ë¡œ íŒë‹¨
          # ai-review.ymlì˜ check-approvalê³¼ ì´ íŒŒì¼ì˜ override-gate ëª¨ë‘ "override" í¬í•¨í•´ì•¼ í•¨
          if [[ "$GATE_DESC" != *"override"* ]]; then
            echo "â„¹ï¸ ë³µì› ë¶ˆí•„ìš” (ê²€ì‚¬ í†µê³¼ë¡œ successë¨)"
            exit 0
          fi

          # AI ë¦¬ë·° ê²°ê³¼ ë‹¤ì‹œ ê³„ì‚° (contextë³„ ìµœì‹  ìƒíƒœë§Œ)
          # âš ï¸ ë™ê¸°í™” í•„ìš”: ì´ ì§‘ê³„ ë¡œì§ì€ ai-review.ymlì—ë„ ìžˆìŒ. ìˆ˜ì • ì‹œ í•¨ê»˜ ë³€ê²½í•  ê²ƒ.
          STATUSES=$(gh api /repos/${{ github.repository }}/commits/$HEAD_SHA/statuses \
            --jq '[.[] | select(.context | startswith("ai-review-"))] | group_by(.context) | map(sort_by([.updated_at, (.state != "pending")]) | last)')

          TOTAL=$(echo "$STATUSES" | jq 'length')
          FAILURE=$(echo "$STATUSES" | jq '[.[] | select(.state == "failure")] | length')

          echo "ê²€ì‚¬ í˜„í™©: ì´ $TOTAL, ì‹¤íŒ¨ $FAILURE"

          # ì‹¤íŒ¨ê°€ ìžˆìœ¼ë©´ ë‹¤ì‹œ failureë¡œ
          if [ "$FAILURE" -gt 0 ]; then
            gh api /repos/${{ github.repository }}/statuses/$HEAD_SHA \
              -f state=failure \
              -f context="merge-gate" \
              -f description="AI ë¦¬ë·° ì‹¤íŒ¨ ${FAILURE}ê°œ - Approve í•„ìš”"

            cat > comment.md << 'EOF'
## âš ï¸ Merge Gate ë³µì›

Approveê°€ ì·¨ì†Œë˜ì–´ merge-gateê°€ ë‹¤ì‹œ failure ìƒíƒœê°€ ë˜ì—ˆìŠµë‹ˆë‹¤.

ë¨¸ì§€í•˜ë ¤ë©´ ë‹¤ì‹œ Approveê°€ í•„ìš”í•©ë‹ˆë‹¤.
EOF
            gh pr comment $PR_NUMBER --body-file comment.md
            echo "âš ï¸ merge-gateë¥¼ failureë¡œ ë³µì›"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
