name: AI Code Review

on:
  # PR ìƒì„± ì‹œ ë¼ë²¨ ì¶”ê°€, ë¼ë²¨ ì œê±° ì‹œ ê²€ì‚¬ ì‹¤í–‰
  pull_request:
    types: [opened, unlabeled]
    branches: [main]

  # ë¼ë²¨ ì—†ëŠ” ìƒíƒœì—ì„œ push ì‹œ ìë™ ì‹¤í–‰
  push:
    branches-ignore:
      - main
      - master

  # ìˆ˜ë™ ì‹¤í–‰
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR ë²ˆí˜¸'
        required: true
        type: number

# ë™ì¼ PRì— ëŒ€í•´ ìˆœì°¨ ì‹¤í–‰ (ë™ì‹œ ì‹¤í–‰ ë°©ì§€)
concurrency:
  group: ai-review-${{ github.event.pull_request.number || github.event.inputs.pr_number || github.ref }}
  cancel-in-progress: false

env:
  REQUIRED_COUNT: ${{ vars.AI_REVIEW_REQUIRED_COUNT || 3 }}
  COOLDOWN_MINUTES: 5
  NOT_READY_LABEL: "ğŸš§ not-ready"

jobs:
  # PR ìƒì„± ì‹œ ë¼ë²¨ ì¶”ê°€
  add-label:
    if: github.event.action == 'opened'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      statuses: write
    steps:
      - name: Create and add label
        run: |
          gh label create "${{ env.NOT_READY_LABEL }}" --description "AI ê²€ì‚¬ ëŒ€ê¸° ì¤‘" --color fbca04 || true
          gh pr edit ${{ github.event.pull_request.number }} --add-label "${{ env.NOT_READY_LABEL }}"

          gh api /repos/${{ github.repository }}/statuses/${{ github.event.pull_request.head.sha }} \
            -f state=pending \
            -f context="merge-gate" \
            -f description="â³ ${{ env.NOT_READY_LABEL }} ë¼ë²¨ ì œê±° í›„ ê²€ì‚¬ ì§„í–‰"

          gh pr comment ${{ github.event.pull_request.number }} --body "## ğŸ“‹ ${{ env.NOT_READY_LABEL }} ë¼ë²¨ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤

**AI ì½”ë“œ ê²€ì‚¬ í”„ë¡œì„¸ìŠ¤:**
1. ê°œë°œ ì¤‘ì—ëŠ” ë¼ë²¨ì´ ë¶™ì–´ìˆì–´ ê²€ì‚¬ê°€ ì‹¤í–‰ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤
2. ê°œë°œ ì™„ë£Œ í›„ **${{ env.NOT_READY_LABEL }} ë¼ë²¨ì„ ì œê±°**í•˜ì„¸ìš”
3. ë¼ë²¨ ì œê±° ì‹œ AI ê²€ì‚¬ê°€ ìë™ìœ¼ë¡œ ì‹¤í–‰ë©ë‹ˆë‹¤
4. ë¨¸ì§€í•˜ë ¤ë©´ **${{ env.REQUIRED_COUNT }}ê°œ**ì˜ AI ê²€ì‚¬ í†µê³¼ê°€ í•„ìš”í•©ë‹ˆë‹¤

> ğŸ’¡ ë¼ë²¨ì´ ë¶™ì–´ìˆìœ¼ë©´ pushí•´ë„ AI ê²€ì‚¬ê°€ ì‹¤í–‰ë˜ì§€ ì•Šì•„ ë¹„ìš©ì´ ì ˆê°ë©ë‹ˆë‹¤.
"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}

  # í…ŒìŠ¤íŠ¸ ë¨¼ì € ì‹¤í–‰
  test:
    if: github.event.action != 'opened'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Run tests
        run: uv run pytest tests/ -v

  # PR ì •ë³´ í™•ì¸ ë° ê²€ì‚¬ í•„ìš” ì—¬ë¶€ íŒë‹¨
  check-conditions:
    if: github.event.action != 'opened'
    needs: test
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
      pr_number: ${{ steps.check.outputs.pr_number }}
      head_sha: ${{ steps.check.outputs.head_sha }}
      next_slot: ${{ steps.check.outputs.next_slot }}

    steps:
      - name: Determine PR info
        id: pr-info
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            PR_NUMBER="${{ github.event.inputs.pr_number }}"
          elif [ "${{ github.event_name }}" = "push" ]; then
            # push ì´ë²¤íŠ¸ì—ì„œ PR ì°¾ê¸°
            PR_NUMBER=$(gh pr list --head "${{ github.ref_name }}" --json number -q '.[0].number')
          else
            PR_NUMBER="${{ github.event.pull_request.number }}"
          fi

          if [ -z "$PR_NUMBER" ]; then
            echo "PRì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            echo "pr_found=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "pr_found=true" >> $GITHUB_OUTPUT

          # PR ìƒì„¸ ì •ë³´ ì¡°íšŒ
          PR_INFO=$(gh pr view $PR_NUMBER --json headRefOid,labels)
          HEAD_SHA=$(echo "$PR_INFO" | jq -r '.headRefOid')
          HAS_NOT_READY=$(echo "$PR_INFO" | jq --arg label "${{ env.NOT_READY_LABEL }}" '[.labels[].name] | map(select(. == $label)) | length')

          echo "has_not_ready=$HAS_NOT_READY" >> $GITHUB_OUTPUT
          echo "head_sha=$HEAD_SHA" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check if should run
        id: check
        run: |
          PR_FOUND="${{ steps.pr-info.outputs.pr_found }}"
          HAS_NOT_READY="${{ steps.pr-info.outputs.has_not_ready }}"
          PR_NUMBER="${{ steps.pr-info.outputs.pr_number }}"
          HEAD_SHA="${{ steps.pr-info.outputs.head_sha }}"
          EVENT="${{ github.event_name }}"

          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "head_sha=$HEAD_SHA" >> $GITHUB_OUTPUT

          # PR ì—†ìœ¼ë©´ ìŠ¤í‚µ
          if [ "$PR_FOUND" != "true" ]; then
            echo "âŒ PRì„ ì°¾ì„ ìˆ˜ ì—†ìŒ"
            echo "should_run=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # not-ready ë¼ë²¨ ìˆìœ¼ë©´ ìŠ¤í‚µ (ìˆ˜ë™ ì‹¤í–‰ ì œì™¸)
          if [ "$HAS_NOT_READY" != "0" ] && [ "$EVENT" != "workflow_dispatch" ]; then
            echo "âŒ ${{ env.NOT_READY_LABEL }} ë¼ë²¨ ìˆìŒ - ê²€ì‚¬ ìŠ¤í‚µ"
            echo "should_run=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # ê¸°ì¡´ status í™•ì¸
          STATUSES=$(gh api /repos/${{ github.repository }}/commits/$HEAD_SHA/statuses --jq '[.[] | select(.context | startswith("ai-review-"))]')

          # ë¹ˆ ìŠ¬ë¡¯ ì°¾ê¸°
          NEXT_SLOT=0
          for i in $(seq 1 ${{ env.REQUIRED_COUNT }}); do
            EXISTS=$(echo "$STATUSES" | jq --arg ctx "ai-review-$i" '[.[] | select(.context == $ctx)] | length')
            if [ "$EXISTS" = "0" ]; then
              NEXT_SLOT=$i
              break
            fi
          done

          echo "next_slot=$NEXT_SLOT" >> $GITHUB_OUTPUT

          # ëª¨ë“  ìŠ¬ë¡¯ ì±„ì›Œì§
          if [ "$NEXT_SLOT" = "0" ]; then
            echo "âŒ ì´ë¯¸ ${{ env.REQUIRED_COUNT }}ê°œ ê²€ì‚¬ ì™„ë£Œ"
            echo "should_run=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # ìë™ ì‹¤í–‰ì¼ ë•Œë§Œ ì¿¨ë‹¤ìš´ ì²´í¬
          if [ "$EVENT" != "workflow_dispatch" ]; then
            # ë§ˆì§€ë§‰ ê²€ì‚¬ ì‹œê°„ í™•ì¸
            LAST_CHECK=$(echo "$STATUSES" | jq -r 'sort_by(.updated_at) | last | .updated_at // empty')

            if [ -n "$LAST_CHECK" ]; then
              LAST_SEC=$(date -d "$LAST_CHECK" +%s)
              NOW_SEC=$(date +%s)
              DIFF=$((NOW_SEC - LAST_SEC))
              COOLDOWN_SEC=$((${{ env.COOLDOWN_MINUTES }} * 60))

              if [ $DIFF -lt $COOLDOWN_SEC ]; then
                REMAINING=$(((COOLDOWN_SEC - DIFF) / 60))
                echo "âŒ ì¿¨ë‹¤ìš´ ì¤‘ - ${REMAINING}ë¶„ í›„ ê°€ëŠ¥"
                echo "should_run=false" >> $GITHUB_OUTPUT
                exit 0
              fi
            fi
          fi

          echo "âœ… ê²€ì‚¬ ì‹¤í–‰ (ìŠ¬ë¡¯: ai-review-$NEXT_SLOT)"
          echo "should_run=true" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # AI ì½”ë“œ ê²€ì‚¬ ì‹¤í–‰
  ai-review:
    needs: check-conditions
    if: needs.check-conditions.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      statuses: write

    outputs:
      result: ${{ steps.ai-check.outputs.result }}
      slot: ${{ needs.check-conditions.outputs.next_slot }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR diff
        id: diff
        run: |
          gh pr diff ${{ needs.check-conditions.outputs.pr_number }} > diff.txt
          DIFF_SIZE=$(wc -c < diff.txt)
          echo "diff_size=$DIFF_SIZE" >> $GITHUB_OUTPUT
          echo "ğŸ“Š Diff í¬ê¸°: $DIFF_SIZE bytes"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Set pending status
        run: |
          gh api /repos/${{ github.repository }}/statuses/${{ needs.check-conditions.outputs.head_sha }} \
            -f state=pending \
            -f context="ai-review-${{ needs.check-conditions.outputs.next_slot }}" \
            -f description="AI ê²€ì‚¬ ì§„í–‰ ì¤‘..."
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Run AI Review
        id: ai-check
        run: |
          echo "ğŸ¤– AI ì½”ë“œ ê²€ì‚¬ ì‹¤í–‰ ì¤‘..."

          # icanhazdadjoke API í˜¸ì¶œ
          RESPONSE=$(curl -s -H "Accept: application/json" https://icanhazdadjoke.com/)
          JOKE=$(echo "$RESPONSE" | jq -r '.joke')
          JOKE_ID=$(echo "$RESPONSE" | jq -r '.id')

          echo "ğŸ­ ë°›ì€ joke: $JOKE"
          echo "ğŸ”‘ joke ID: $JOKE_ID"

          # ê¸€ììˆ˜ë¡œ pass/fail íŒì • (í™€ìˆ˜: pass, ì§ìˆ˜: fail)
          JOKE_LENGTH=${#JOKE}
          echo "ğŸ“ ê¸€ììˆ˜: $JOKE_LENGTH"

          if [ $((JOKE_LENGTH % 2)) -eq 1 ]; then
            RESULT="pass"
            SUMMARY="ì½”ë“œ í’ˆì§ˆì´ ì–‘í˜¸í•©ë‹ˆë‹¤. (joke ê¸€ììˆ˜: ${JOKE_LENGTH}ì - í™€ìˆ˜)"
          else
            RESULT="fail"
            SUMMARY="ê°œì„ ì´ í•„ìš”í•œ ë¶€ë¶„ì´ ìˆìŠµë‹ˆë‹¤. (joke ê¸€ììˆ˜: ${JOKE_LENGTH}ì - ì§ìˆ˜)"
          fi

          echo "result=$RESULT" >> $GITHUB_OUTPUT
          echo "summary=$SUMMARY" >> $GITHUB_OUTPUT

          # jokeë¥¼ íŒŒì¼ë¡œ ì €ì¥ (multiline ëŒ€ì‘)
          echo "$JOKE" > joke.txt
          echo "$JOKE_ID" > joke_id.txt

          echo "ê²°ê³¼: $RESULT"

      - name: Set final status
        run: |
          if [ "${{ steps.ai-check.outputs.result }}" = "pass" ]; then
            STATE="success"
            DESC="âœ… AI ê²€ì‚¬ í†µê³¼"
          else
            STATE="failure"
            DESC="âŒ AI ê²€ì‚¬ ì‹¤íŒ¨"
          fi

          gh api /repos/${{ github.repository }}/statuses/${{ needs.check-conditions.outputs.head_sha }} \
            -f state="$STATE" \
            -f context="ai-review-${{ needs.check-conditions.outputs.next_slot }}" \
            -f description="$DESC"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Post PR comment
        run: |
          SLOT="${{ needs.check-conditions.outputs.next_slot }}"
          RESULT="${{ steps.ai-check.outputs.result }}"
          SUMMARY="${{ steps.ai-check.outputs.summary }}"
          JOKE=$(cat joke.txt)
          JOKE_ID=$(cat joke_id.txt)
          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          if [ "$RESULT" = "pass" ]; then
            EMOJI="âœ…"
            STATUS="í†µê³¼"
          else
            EMOJI="âŒ"
            STATUS="ì‹¤íŒ¨"
          fi

          BODY="## ${EMOJI} AI ì½”ë“œ ê²€ì‚¬ #${SLOT} - ${STATUS}

**ìš”ì•½**: ${SUMMARY}

### ğŸ­ ì˜¤ëŠ˜ì˜ Joke
> ${JOKE}

\`ID: ${JOKE_ID}\`

---
ğŸ”— [ìƒì„¸ ë¡œê·¸](${RUN_URL}) | ğŸ“… $(date '+%Y-%m-%d %H:%M:%S')
"

          gh pr comment ${{ needs.check-conditions.outputs.pr_number }} --body "$BODY"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ì¢…í•© íŒì • (merge-gate)
  update-gate:
    needs: [check-conditions, ai-review]
    if: always() && needs.check-conditions.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    permissions:
      statuses: write
      pull-requests: read

    steps:
      - name: Calculate merge gate
        run: |
          HEAD_SHA="${{ needs.check-conditions.outputs.head_sha }}"
          PR_NUMBER="${{ needs.check-conditions.outputs.pr_number }}"
          REQUIRED=${{ env.REQUIRED_COUNT }}

          # ëª¨ë“  ai-review status ì¡°íšŒ
          STATUSES=$(gh api /repos/${{ github.repository }}/commits/$HEAD_SHA/statuses \
            --jq '[.[] | select(.context | startswith("ai-review-"))]')

          TOTAL=$(echo "$STATUSES" | jq 'length')
          SUCCESS=$(echo "$STATUSES" | jq '[.[] | select(.state == "success")] | length')
          FAILURE=$(echo "$STATUSES" | jq '[.[] | select(.state == "failure")] | length')

          echo "ğŸ“Š ê²€ì‚¬ í˜„í™©: ì´ $TOTAL / í•„ìš” $REQUIRED (í†µê³¼: $SUCCESS, ì‹¤íŒ¨: $FAILURE)"

          # ì•„ì§ Nê°œ ì•ˆ ì±„ì›Œì§
          if [ "$TOTAL" -lt "$REQUIRED" ]; then
            gh api /repos/${{ github.repository }}/statuses/$HEAD_SHA \
              -f state=pending \
              -f context="merge-gate" \
              -f description="AI ê²€ì‚¬ ${TOTAL}/${REQUIRED} ì™„ë£Œ"
            echo "â³ ì¶”ê°€ ê²€ì‚¬ í•„ìš”"
            exit 0
          fi

          # Nê°œ ì±„ì›Œì§ - ê²°ê³¼ íŒì •
          if [ "$FAILURE" -eq 0 ]; then
            # ì „ë¶€ í†µê³¼
            gh api /repos/${{ github.repository }}/statuses/$HEAD_SHA \
              -f state=success \
              -f context="merge-gate" \
              -f description="âœ… AI ê²€ì‚¬ ${SUCCESS}/${REQUIRED} í†µê³¼"
            echo "âœ… ë¨¸ì§€ ê°€ëŠ¥"
          else
            # 1ê°œë¼ë„ ì‹¤íŒ¨ - Approve í•„ìš”
            gh api /repos/${{ github.repository }}/statuses/$HEAD_SHA \
              -f state=failure \
              -f context="merge-gate" \
              -f description="âŒ AI ê²€ì‚¬ ì‹¤íŒ¨ ${FAILURE}ê°œ - Approve í•„ìš”"
            echo "âŒ ì‚¬ëŒ ìŠ¹ì¸ í•„ìš”"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Approve ì‹œ merge-gate override
  check-approval:
    needs: [check-conditions, ai-review, update-gate]
    if: always() && needs.check-conditions.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    permissions:
      statuses: write
      pull-requests: read

    steps:
      - name: Check for approvals
        run: |
          HEAD_SHA="${{ needs.check-conditions.outputs.head_sha }}"
          PR_NUMBER="${{ needs.check-conditions.outputs.pr_number }}"

          # í˜„ì¬ merge-gate ìƒíƒœ í™•ì¸
          GATE_STATE=$(gh api /repos/${{ github.repository }}/commits/$HEAD_SHA/statuses \
            --jq '[.[] | select(.context == "merge-gate")] | .[0].state // "pending"')

          # ì´ë¯¸ ì„±ê³µì´ë©´ ìŠ¤í‚µ
          if [ "$GATE_STATE" = "success" ]; then
            echo "âœ… ì´ë¯¸ í†µê³¼ ìƒíƒœ"
            exit 0
          fi

          # Approve ìˆëŠ”ì§€ í™•ì¸
          APPROVALS=$(gh pr view $PR_NUMBER --json reviews \
            --jq '[.reviews[] | select(.state == "APPROVED")] | length')

          echo "ğŸ‘¥ Approve ìˆ˜: $APPROVALS"

          if [ "$APPROVALS" -gt 0 ]; then
            gh api /repos/${{ github.repository }}/statuses/$HEAD_SHA \
              -f state=success \
              -f context="merge-gate" \
              -f description="âœ… ì‚¬ëŒ ìŠ¹ì¸ìœ¼ë¡œ override"
            echo "âœ… Approveë¡œ ë¨¸ì§€ ê°€ëŠ¥"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
