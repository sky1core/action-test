name: Approval Override

on:
  pull_request_review:
    types: [submitted, dismissed]

jobs:
  override-gate:
    if: |
      github.event.action == 'submitted' &&
      github.event.review.state == 'approved' &&
      (github.event.pull_request.base.ref == 'main')
    runs-on: ubuntu-latest
    permissions:
      statuses: write
      pull-requests: write

    steps:
      - name: Override PR Checks Status if needed
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"

          GATE_STATUS=$(curl -sf -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "${{ github.api_url }}/repos/${{ github.repository }}/commits/$HEAD_SHA/statuses" \
            | jq '[.[] | select(.context == "PR Checks Status")] | sort_by(.updated_at) | last')

          GATE_STATE=$(echo "$GATE_STATUS" | jq -r '.state // "none"')

          if [ "$GATE_STATE" != "success" ]; then
            curl -sf -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Content-Type: application/json" \
              -X POST "${{ github.api_url }}/repos/${{ github.repository }}/statuses/$HEAD_SHA" \
              -d '{"state":"success","context":"PR Checks Status","description":"Overridden by approval (@${{ github.event.review.user.login }})"}'

            printf '## ✅ Merge Gate Override\n\n**@%s**의 승인으로 PR Checks Status가 override 되었습니다.\n\n머지가 가능합니다.' "${{ github.event.review.user.login }}" > comment.md
            BODY=$(jq -Rs '.' comment.md)
            curl -sf -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Content-Type: application/json" \
              -X POST "${{ github.api_url }}/repos/${{ github.repository }}/issues/$PR_NUMBER/comments" \
              -d "{\"body\": $BODY}"
          fi

  restore-gate:
    if: |
      github.event.action == 'dismissed' &&
      (github.event.pull_request.base.ref == 'main')
    runs-on: ubuntu-latest
    permissions:
      statuses: write
      pull-requests: write

    steps:
      - name: Restore PR Checks Status if needed
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"

          # 다른 Approve가 있으면 무시
          APPROVALS=$(curl -sf -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "${{ github.api_url }}/repos/${{ github.repository }}/pulls/$PR_NUMBER/reviews" \
            | jq '[.[] | select(.state == "APPROVED")] | length')

          if [ "$APPROVALS" -gt 0 ]; then
            exit 0
          fi

          # 현재 PR Checks Status 확인
          GATE_STATUS=$(curl -sf -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "${{ github.api_url }}/repos/${{ github.repository }}/commits/$HEAD_SHA/statuses" \
            | jq '[.[] | select(.context == "PR Checks Status")] | sort_by(.updated_at) | last')

          GATE_STATE=$(echo "$GATE_STATUS" | jq -r '.state // "none"')
          GATE_DESC=$(echo "$GATE_STATUS" | jq -r '.description // ""')

          # success가 아니면 복원 불필요
          if [ "$GATE_STATE" != "success" ]; then
            exit 0
          fi

          # Override된 상태가 아니면 복원 불필요
          if [[ "$GATE_DESC" != *"Overridden"* ]]; then
            exit 0
          fi

          # 각 체크 상태 확인
          SHOULD_RESTORE="false"

          # unit-test 상태 확인
          UNIT_TEST_STATE=$(curl -sf -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "${{ github.api_url }}/repos/${{ github.repository }}/commits/$HEAD_SHA/statuses" \
            | jq -r '[.[] | select(.context == "unit-test")] | sort_by(.updated_at) | last | .state // "none"')
          if [ "$UNIT_TEST_STATE" != "success" ]; then
            SHOULD_RESTORE="true"
          fi

          # ai-review 실행 여부 확인
          AI_REVIEW_STATE=$(curl -sf -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "${{ github.api_url }}/repos/${{ github.repository }}/commits/$HEAD_SHA/statuses" \
            | jq -r '[.[] | select(.context == "ai-review")] | sort_by(.updated_at) | last | .state // "none"')
          if [ "$AI_REVIEW_STATE" = "none" ] || [ "$AI_REVIEW_STATE" = "pending" ]; then
            SHOULD_RESTORE="true"
          fi

          if [ "$SHOULD_RESTORE" = "true" ]; then
            curl -sf -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Content-Type: application/json" \
              -X POST "${{ github.api_url }}/repos/${{ github.repository }}/statuses/$HEAD_SHA" \
              -d '{"state":"failure","context":"PR Checks Status","description":"Approval required"}'

            printf '## ⚠️ Merge Gate 복원\n\nApprove가 취소되어 PR Checks Status가 다시 failure 상태가 되었습니다.\n\n머지하려면 다시 Approve가 필요합니다.' > comment.md
            BODY=$(jq -Rs '.' comment.md)
            curl -sf -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Content-Type: application/json" \
              -X POST "${{ github.api_url }}/repos/${{ github.repository }}/issues/$PR_NUMBER/comments" \
              -d "{\"body\": $BODY}"
          fi
